<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - JNJ Website</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="chat.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>
</head>
<body>
    <a href="index.html" class="back-button">‚Üê Back to Home</a>
    
    <div class="chat-container">
        <header class="chat-header">
            <h1>JNJ Chat</h1>
            <p class="chat-subtitle">Junhu Choi ‚Ä¢ Jaxon Croskey ‚Ä¢ Nathan DeLuca</p>
        </header>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message welcome-message">
                <div class="message-content">
                    <p>Welcome to JNJ Chat! Start a conversation below.</p>
                </div>
            </div>
        </div>
        
        <div class="chat-input-container">
            <div class="user-name-container" id="userNameContainer">
                <label for="userNameInput">Your name:</label>
                <div class="name-input-wrapper">
                    <input 
                        type="text" 
                        id="userNameInput" 
                        class="user-name-input" 
                        placeholder="Enter your name..."
                        autocomplete="off"
                        maxlength="30"
                    >
                    <button id="saveNameButton" class="save-name-button">Save</button>
                </div>
                <div class="current-name-display" id="currentNameDisplay" style="display: none;">
                    <span>Chatting as: <strong id="currentNameText"></strong></span>
                    <button id="changeNameButton" class="change-name-button">Change</button>
                </div>
            </div>
            <div class="input-wrapper">
                <input 
                    type="text" 
                    id="messageInput" 
                    class="message-input" 
                    placeholder="Type a message..."
                    autocomplete="off"
                    disabled
                >
                <label for="imageInput" class="image-upload-button" title="Upload Image">
                    üì∑
                </label>
                <input 
                    type="file" 
                    id="imageInput" 
                    accept="image/*"
                    style="display: none;"
                    disabled
                >
                <button id="sendButton" class="send-button" disabled>Send</button>
            </div>
            <div id="imagePreview" class="image-preview" style="display: none;">
                <img id="previewImage" src="" alt="Preview">
                <button id="removeImageButton" class="remove-image-button">‚úï</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Firebase
        let db = null;
        let messagesUnsubscribe = null;
        
        try {
            if (typeof firebaseConfig !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                console.log('Firebase connected successfully!');
            } else {
                console.warn('Firebase config not found. Using localStorage fallback.');
            }
        } catch (error) {
            console.error('Firebase initialization error:', error);
            console.warn('Falling back to localStorage.');
        }

        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const userNameInput = document.getElementById('userNameInput');
        const saveNameButton = document.getElementById('saveNameButton');
        const currentNameDisplay = document.getElementById('currentNameDisplay');
        const currentNameText = document.getElementById('currentNameText');
        const changeNameButton = document.getElementById('changeNameButton');
        const nameInputWrapper = userNameInput.parentElement;

        let currentUserName = '';
        let loadedMessageIds = new Set(); // Track loaded messages to prevent duplicates
        const MAX_VISIBLE_MESSAGES = 35; // Maximum number of messages to display
        let isInitialLoad = true; // Track if this is the first load
        let selectedImage = null; // Store selected image as base64

        // Load saved name from localStorage (still using localStorage for user name)
        function loadUserName() {
            const savedName = localStorage.getItem('jjnChatUserName');
            if (savedName && savedName.trim() !== '') {
                currentUserName = savedName.trim();
                showNameDisplay();
                enableChat();
            } else {
                showNameInput();
            }
        }

        // Save name to localStorage (still using localStorage for user name)
        function saveUserName(name) {
            const trimmedName = name.trim();
            if (trimmedName === '') return false;
            
            localStorage.setItem('jjnChatUserName', trimmedName);
            currentUserName = trimmedName;
            showNameDisplay();
            enableChat();
            return true;
        }

        // Show name input field
        function showNameInput() {
            nameInputWrapper.style.display = 'flex';
            currentNameDisplay.style.display = 'none';
            userNameInput.value = '';
            userNameInput.focus();
            disableChat();
        }

        // Show current name display
        function showNameDisplay() {
            nameInputWrapper.style.display = 'none';
            currentNameDisplay.style.display = 'flex';
            currentNameText.textContent = currentUserName;
        }

        // Enable chat input
        function enableChat() {
            messageInput.disabled = false;
            sendButton.disabled = false;
            document.getElementById('imageInput').disabled = false;
            messageInput.placeholder = 'Type a message...';
        }

        // Disable chat input
        function disableChat() {
            messageInput.disabled = true;
            sendButton.disabled = true;
            document.getElementById('imageInput').disabled = true;
            messageInput.placeholder = 'Enter your name above to start chatting...';
        }

        // Load messages from Firestore or localStorage fallback
        function loadMessages() {
            if (db) {
                // Use Firestore with real-time updates
                loadMessagesFromFirestore();
            } else {
                // Fallback to localStorage
                const messages = JSON.parse(localStorage.getItem('jjnChatMessages') || '[]');
                // Only show the most recent messages
                const recentMessages = messages.slice(-MAX_VISIBLE_MESSAGES);
                recentMessages.forEach(msg => {
                    addMessageToChat(msg.user, msg.message, msg.timestamp, false);
                });
                scrollToBottom();
            }
        }

        // Load messages from Firestore with real-time listener
        function loadMessagesFromFirestore() {
            // Set up real-time listener that gets all current messages and then listens for changes
            messagesUnsubscribe = db.collection('messages')
                .orderBy('timestamp', 'desc')
                .limit(MAX_VISIBLE_MESSAGES)
                .onSnapshot((querySnapshot) => {
                    // On initial load, clear and reload all messages
                    if (isInitialLoad) {
                        const existingMessages = chatMessages.querySelectorAll('.message:not(.welcome-message)');
                        existingMessages.forEach(msg => msg.remove());
                        loadedMessageIds.clear();
                        
                    const messages = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        messages.push({
                            id: doc.id,
                            user: data.user,
                            message: data.message,
                            timestamp: data.timestamp,
                            image: data.image || null
                        });
                        loadedMessageIds.add(doc.id);
                    });
                    
                    // Display messages in reverse order (oldest first)
                    messages.reverse().forEach(msg => {
                        addMessageToChat(msg.user, msg.message, msg.timestamp, false, msg.image);
                    });
                        scrollToBottom();
                        isInitialLoad = false;
                    } else {
                        // After initial load, only process new changes
                        querySnapshot.docChanges().forEach((change) => {
                            if (change.type === 'added' && !loadedMessageIds.has(change.doc.id)) {
                                const data = change.doc.data();
                                addMessageToChat(data.user, data.message, data.timestamp, false, data.image || null);
                                loadedMessageIds.add(change.doc.id);
                            }
                        });
                    }
                }, (error) => {
                    console.error('Error in real-time listener:', error);
                    // Fallback to localStorage
                    const messages = JSON.parse(localStorage.getItem('jjnChatMessages') || '[]');
                    // Only show the most recent messages
                    const recentMessages = messages.slice(-MAX_VISIBLE_MESSAGES);
                    recentMessages.forEach(msg => {
                        addMessageToChat(msg.user, msg.message, msg.timestamp, false, msg.image || null);
                    });
                });
        }

        // Save message to Firestore or localStorage fallback
        function saveMessage(user, message, timestamp, imageData = null) {
            const messageData = {
                user: user,
                message: message,
                timestamp: timestamp
            };
            
            if (imageData) {
                messageData.image = imageData;
            }
            
            if (db) {
                // Save to Firestore
                db.collection('messages').add(messageData)
                .catch((error) => {
                    console.error('Error saving message to Firestore:', error);
                    // Fallback to localStorage
                    saveMessageToLocalStorage(user, message, timestamp, imageData);
                });
            } else {
                // Fallback to localStorage
                saveMessageToLocalStorage(user, message, timestamp, imageData);
            }
        }

        // Fallback: Save messages to localStorage
        function saveMessageToLocalStorage(user, message, timestamp, imageData = null) {
            const messages = JSON.parse(localStorage.getItem('jjnChatMessages') || '[]');
            const messageObj = { user, message, timestamp };
            if (imageData) {
                messageObj.image = imageData;
            }
            messages.push(messageObj);
            // Keep only last 100 messages
            if (messages.length > 100) {
                messages.shift();
            }
            localStorage.setItem('jjnChatMessages', JSON.stringify(messages));
        }

        // Add message to chat display
        function addMessageToChat(user, message, timestamp, shouldSave = true, imageData = null) {
            // Remove welcome message if it exists
            const welcomeMsg = chatMessages.querySelector('.welcome-message');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }

            if (shouldSave) {
                saveMessage(user, message, timestamp, imageData);
            }

            // Check if message already exists (prevent duplicates)
            const existingMessages = chatMessages.querySelectorAll('.message:not(.welcome-message)');
            for (let msg of existingMessages) {
                const msgTime = msg.getAttribute('data-timestamp');
                const msgUser = msg.querySelector('.message-user').textContent;
                const msgContent = msg.querySelector('.message-content p')?.textContent || '';
                const msgImage = msg.querySelector('.message-image');
                const hasImage = msgImage !== null;
                if (msgTime == timestamp && msgUser === user && msgContent === message && hasImage === !!imageData) {
                    return; // Message already exists, don't add duplicate
                }
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.setAttribute('data-timestamp', timestamp);
            
            const time = new Date(timestamp);
            const timeString = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            let imageHtml = '';
            if (imageData) {
                imageHtml = `<div class="message-image"><img src="${imageData}" alt="Uploaded image" onclick="this.classList.toggle('expanded')"></div>`;
            }
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-user">${escapeHtml(user)}</span>
                    <span class="message-time">${timeString}</span>
                </div>
                <div class="message-content">
                    ${imageHtml}
                    ${message ? `<p>${escapeHtml(message)}</p>` : ''}
                </div>
            `;
            
            // Insert message in correct chronological order
            const allMessages = Array.from(chatMessages.querySelectorAll('.message:not(.welcome-message)'));
            let inserted = false;
            for (let i = 0; i < allMessages.length; i++) {
                const msgTimestamp = parseInt(allMessages[i].getAttribute('data-timestamp') || '0');
                if (timestamp < msgTimestamp) {
                    chatMessages.insertBefore(messageDiv, allMessages[i]);
                    inserted = true;
                    break;
                }
            }
            if (!inserted) {
                chatMessages.appendChild(messageDiv);
            }
            
            // Remove old messages if we exceed the limit
            limitVisibleMessages();
            
            scrollToBottom();
        }

        // Limit visible messages to MAX_VISIBLE_MESSAGES
        function limitVisibleMessages() {
            const allMessages = chatMessages.querySelectorAll('.message:not(.welcome-message)');
            if (allMessages.length > MAX_VISIBLE_MESSAGES) {
                // Remove the oldest messages (first ones in the list)
                const messagesToRemove = allMessages.length - MAX_VISIBLE_MESSAGES;
                for (let i = 0; i < messagesToRemove; i++) {
                    allMessages[i].remove();
                }
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Scroll to bottom of chat
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Send message
        function sendMessage() {
            const message = messageInput.value.trim();
            if ((message === '' && !selectedImage) || !currentUserName) return;

            const timestamp = Date.now();
            const imageData = selectedImage;
            
            // Clear image preview
            if (selectedImage) {
                selectedImage = null;
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('previewImage').src = '';
                document.getElementById('imageInput').value = '';
            }
            
            if (db) {
                // Save to Firestore first
                saveMessage(currentUserName, message, timestamp, imageData);
                
                // Add to display immediately for better UX
                addMessageToChat(currentUserName, message, timestamp, false, imageData);
            } else {
                addMessageToChat(currentUserName, message, timestamp, true, imageData);
            }
            messageInput.value = '';
            messageInput.focus();
        }
        
        // Handle image selection
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Image is too large! Maximum size is 5MB.');
                event.target.value = '';
                return;
            }
            
            // Check if it's an image
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file.');
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                selectedImage = e.target.result; // Store as base64
                document.getElementById('previewImage').src = selectedImage;
                document.getElementById('imagePreview').style.display = 'flex';
            };
            reader.readAsDataURL(file);
        }
        
        // Remove selected image
        function removeImage() {
            selectedImage = null;
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('previewImage').src = '';
            document.getElementById('imageInput').value = '';
        }

        // Save name handler
        function handleSaveName() {
            const name = userNameInput.value.trim();
            if (name === '') {
                userNameInput.focus();
                return;
            }
            if (saveUserName(name)) {
                userNameInput.value = '';
            }
        }

        // Event listeners
        saveNameButton.addEventListener('click', handleSaveName);
        userNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSaveName();
            }
        });
        changeNameButton.addEventListener('click', showNameInput);
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        document.getElementById('imageInput').addEventListener('change', handleImageSelect);
        document.getElementById('removeImageButton').addEventListener('click', removeImage);

        // Initialize on page load
        loadUserName();
        loadMessages();
        
        // Cursor Trail Effect - Smooth line effect
        const trails = [];
        const maxTrails = 50;
        let lastTime = 0;
        
        function createCursorTrail(x, y, delay = 0) {
            setTimeout(() => {
                const trail = document.createElement('div');
                trail.className = 'cursor-trail';
                trail.style.left = x + 'px';
                trail.style.top = y + 'px';
                trail.style.opacity = '0.6';
                document.body.appendChild(trail);
                
                requestAnimationFrame(() => {
                    trail.style.opacity = '0';
                    trail.style.transform = 'translate(-50%, -50%) scale(0.2)';
                });
                
                setTimeout(() => {
                    if (trail.parentNode) {
                        trail.remove();
                    }
                }, 800);
                
                trails.push(trail);
                if (trails.length > maxTrails) {
                    const oldTrail = trails.shift();
                    if (oldTrail && oldTrail.parentNode) {
                        oldTrail.remove();
                    }
                }
            }, delay);
        }
        
        let lastX = 0;
        let lastY = 0;
        let mouseX = 0;
        let mouseY = 0;
        
        document.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
            
            const now = Date.now();
            const timeSinceLastTrail = now - lastTime;
            
            if (timeSinceLastTrail > 8) {
                const distance = Math.sqrt(
                    Math.pow(mouseX - lastX, 2) + Math.pow(mouseY - lastY, 2)
                );
                
                if (distance > 2) {
                    createCursorTrail(mouseX, mouseY);
                    lastX = mouseX;
                    lastY = mouseY;
                    lastTime = now;
                }
            }
        });
    </script>
</body>
</html>

