<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - JJN Website</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="chat.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>
</head>
<body>
    <a href="index.html" class="back-button">← Back to Home</a>
    
    <div class="chat-container">
        <header class="chat-header">
            <h1>JJN Chat</h1>
            <p class="chat-subtitle">Junhu Choi • Jaxon Croskey • Nathan DeLuca</p>
        </header>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message welcome-message">
                <div class="message-content">
                    <p>Welcome to JJN Chat! Start a conversation below.</p>
                </div>
            </div>
        </div>
        
        <div class="chat-input-container">
            <div class="user-name-container" id="userNameContainer">
                <label for="userNameInput">Your name:</label>
                <div class="name-input-wrapper">
                    <input 
                        type="text" 
                        id="userNameInput" 
                        class="user-name-input" 
                        placeholder="Enter your name..."
                        autocomplete="off"
                        maxlength="30"
                    >
                    <button id="saveNameButton" class="save-name-button">Save</button>
                </div>
                <div class="current-name-display" id="currentNameDisplay" style="display: none;">
                    <span>Chatting as: <strong id="currentNameText"></strong></span>
                    <button id="changeNameButton" class="change-name-button">Change</button>
                </div>
            </div>
            <div class="input-wrapper">
                <input 
                    type="text" 
                    id="messageInput" 
                    class="message-input" 
                    placeholder="Type a message..."
                    autocomplete="off"
                    disabled
                >
                <button id="sendButton" class="send-button" disabled>Send</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Firebase
        let db = null;
        let messagesUnsubscribe = null;
        
        try {
            if (typeof firebaseConfig !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                console.log('Firebase connected successfully!');
            } else {
                console.warn('Firebase config not found. Using localStorage fallback.');
            }
        } catch (error) {
            console.error('Firebase initialization error:', error);
            console.warn('Falling back to localStorage.');
        }

        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const userNameInput = document.getElementById('userNameInput');
        const saveNameButton = document.getElementById('saveNameButton');
        const currentNameDisplay = document.getElementById('currentNameDisplay');
        const currentNameText = document.getElementById('currentNameText');
        const changeNameButton = document.getElementById('changeNameButton');
        const nameInputWrapper = userNameInput.parentElement;

        let currentUserName = '';
        let loadedMessageIds = new Set(); // Track loaded messages to prevent duplicates
        let recentlySentMessages = new Set(); // Track recently sent messages to prevent duplicates from listener
        const MAX_VISIBLE_MESSAGES = 35; // Maximum number of messages to display

        // Load saved name from localStorage (still using localStorage for user name)
        function loadUserName() {
            const savedName = localStorage.getItem('jjnChatUserName');
            if (savedName && savedName.trim() !== '') {
                currentUserName = savedName.trim();
                showNameDisplay();
                enableChat();
            } else {
                showNameInput();
            }
        }

        // Save name to localStorage (still using localStorage for user name)
        function saveUserName(name) {
            const trimmedName = name.trim();
            if (trimmedName === '') return false;
            
            localStorage.setItem('jjnChatUserName', trimmedName);
            currentUserName = trimmedName;
            showNameDisplay();
            enableChat();
            return true;
        }

        // Show name input field
        function showNameInput() {
            nameInputWrapper.style.display = 'flex';
            currentNameDisplay.style.display = 'none';
            userNameInput.value = '';
            userNameInput.focus();
            disableChat();
        }

        // Show current name display
        function showNameDisplay() {
            nameInputWrapper.style.display = 'none';
            currentNameDisplay.style.display = 'flex';
            currentNameText.textContent = currentUserName;
        }

        // Enable chat input
        function enableChat() {
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.placeholder = 'Type a message...';
        }

        // Disable chat input
        function disableChat() {
            messageInput.disabled = true;
            sendButton.disabled = true;
            messageInput.placeholder = 'Enter your name above to start chatting...';
        }

        // Load messages from Firestore or localStorage fallback
        function loadMessages() {
            if (db) {
                // Use Firestore with real-time updates
                loadMessagesFromFirestore();
            } else {
                // Fallback to localStorage
                const messages = JSON.parse(localStorage.getItem('jjnChatMessages') || '[]');
                // Only show the most recent messages
                const recentMessages = messages.slice(-MAX_VISIBLE_MESSAGES);
                recentMessages.forEach(msg => {
                    addMessageToChat(msg.user, msg.message, msg.timestamp, false);
                });
                scrollToBottom();
            }
        }

        // Load messages from Firestore with real-time listener
        function loadMessagesFromFirestore() {
            // First, load existing messages (only the most recent ones)
            db.collection('messages')
                .orderBy('timestamp', 'desc')
                .limit(MAX_VISIBLE_MESSAGES)
                .get()
                .then((querySnapshot) => {
                    const messages = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        messages.push({
                            id: doc.id,
                            user: data.user,
                            message: data.message,
                            timestamp: data.timestamp
                        });
                        loadedMessageIds.add(doc.id);
                    });
                    
                    // Display messages in reverse order (oldest first)
                    messages.reverse().forEach(msg => {
                        addMessageToChat(msg.user, msg.message, msg.timestamp, false);
                    });
                    scrollToBottom();
                })
                .catch((error) => {
                    console.error('Error loading messages:', error);
                    // Fallback to localStorage
                    const messages = JSON.parse(localStorage.getItem('jjnChatMessages') || '[]');
                    // Only show the most recent messages
                    const recentMessages = messages.slice(-MAX_VISIBLE_MESSAGES);
                    recentMessages.forEach(msg => {
                        addMessageToChat(msg.user, msg.message, msg.timestamp, false);
                    });
                });

            // Set up real-time listener for new messages
            messagesUnsubscribe = db.collection('messages')
                .orderBy('timestamp', 'desc')
                .onSnapshot((querySnapshot) => {
                    querySnapshot.docChanges().forEach((change) => {
                        if (change.type === 'added' && !loadedMessageIds.has(change.doc.id)) {
                            const data = change.doc.data();
                            // Create a unique key to check if this is a message we just sent
                            const messageKey = `${data.user}-${data.message}-${data.timestamp}`;
                            
                            // Skip if this is a message we just sent (to prevent duplicates)
                            if (!recentlySentMessages.has(messageKey)) {
                                addMessageToChat(data.user, data.message, data.timestamp, false);
                                loadedMessageIds.add(change.doc.id);
                            } else {
                                // Remove from recently sent after processing
                                recentlySentMessages.delete(messageKey);
                                loadedMessageIds.add(change.doc.id);
                            }
                        }
                    });
                }, (error) => {
                    console.error('Error in real-time listener:', error);
                });
        }

        // Save message to Firestore or localStorage fallback
        function saveMessage(user, message, timestamp) {
            if (db) {
                // Save to Firestore
                db.collection('messages').add({
                    user: user,
                    message: message,
                    timestamp: timestamp
                })
                .catch((error) => {
                    console.error('Error saving message to Firestore:', error);
                    // Fallback to localStorage
                    saveMessageToLocalStorage(user, message, timestamp);
                });
            } else {
                // Fallback to localStorage
                saveMessageToLocalStorage(user, message, timestamp);
            }
        }

        // Fallback: Save messages to localStorage
        function saveMessageToLocalStorage(user, message, timestamp) {
            const messages = JSON.parse(localStorage.getItem('jjnChatMessages') || '[]');
            messages.push({ user, message, timestamp });
            // Keep only last 100 messages
            if (messages.length > 100) {
                messages.shift();
            }
            localStorage.setItem('jjnChatMessages', JSON.stringify(messages));
        }

        // Add message to chat display
        function addMessageToChat(user, message, timestamp, shouldSave = true) {
            // Remove welcome message if it exists
            const welcomeMsg = chatMessages.querySelector('.welcome-message');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }

            if (shouldSave) {
                saveMessage(user, message, timestamp);
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            const time = new Date(timestamp);
            const timeString = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-user">${escapeHtml(user)}</span>
                    <span class="message-time">${timeString}</span>
                </div>
                <div class="message-content">
                    <p>${escapeHtml(message)}</p>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            
            // Remove old messages if we exceed the limit
            limitVisibleMessages();
            
            scrollToBottom();
        }

        // Limit visible messages to MAX_VISIBLE_MESSAGES
        function limitVisibleMessages() {
            const allMessages = chatMessages.querySelectorAll('.message:not(.welcome-message)');
            if (allMessages.length > MAX_VISIBLE_MESSAGES) {
                // Remove the oldest messages (first ones in the list)
                const messagesToRemove = allMessages.length - MAX_VISIBLE_MESSAGES;
                for (let i = 0; i < messagesToRemove; i++) {
                    allMessages[i].remove();
                }
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Scroll to bottom of chat
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Send message
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message === '' || !currentUserName) return;

            const timestamp = Date.now();
            
            if (db) {
                // Create unique key to track this message
                const messageKey = `${currentUserName}-${message}-${timestamp}`;
                recentlySentMessages.add(messageKey);
                
                // Add to display immediately for better UX
                addMessageToChat(currentUserName, message, timestamp, false);
                
                // Save to Firestore (listener will skip it because of recentlySentMessages)
                saveMessage(currentUserName, message, timestamp);
                
                // Clean up the tracking after a delay (in case listener is slow)
                setTimeout(() => {
                    recentlySentMessages.delete(messageKey);
                }, 2000);
            } else {
                addMessageToChat(currentUserName, message, timestamp);
            }
            messageInput.value = '';
            messageInput.focus();
        }

        // Save name handler
        function handleSaveName() {
            const name = userNameInput.value.trim();
            if (name === '') {
                userNameInput.focus();
                return;
            }
            if (saveUserName(name)) {
                userNameInput.value = '';
            }
        }

        // Event listeners
        saveNameButton.addEventListener('click', handleSaveName);
        userNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSaveName();
            }
        });
        changeNameButton.addEventListener('click', showNameInput);
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Initialize on page load
        loadUserName();
        loadMessages();
    </script>
</body>
</html>

