<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - JNJ Website</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="chat.css">
    <link rel="stylesheet" href="animated-background.css">
    <script src="page-transitions.js" defer></script>
    <script src="animated-background.js" defer></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>
</head>
<body>
    <a href="index.html" class="back-button">‚Üê Back to Home</a>
    
    <div class="chat-container">
        <header class="chat-header">
            <h1>JNJ Chat</h1>
            <p class="chat-subtitle">Junhu Choi ‚Ä¢ Jaxon Croskey ‚Ä¢ Nathan DeLuca</p>
            <div class="room-controls">
                <button id="createRoomButton" class="room-button" style="display: none;">Create Private Room</button>
                <button id="joinRoomButton" class="room-button" style="display: none;">Join Room</button>
                <button id="leaveRoomButton" class="room-button room-button-leave" style="display: none;">Leave Room</button>
                <div id="roomCodeDisplay" class="room-code-display" style="display: none;">
                    <span>Room: <strong id="currentRoomCodeDisplay"></strong></span>
                </div>
            </div>
        </header>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message welcome-message">
                <div class="message-content">
                    <p>Welcome to JNJ Chat! Start a conversation below.</p>
                </div>
            </div>
        </div>
        
        <div class="chat-input-container">
            <div class="user-name-container" id="userNameContainer">
                <label for="userNameInput">Your name:</label>
                <div class="name-input-wrapper">
                    <input 
                        type="text" 
                        id="userNameInput" 
                        class="user-name-input" 
                        placeholder="Enter your name..."
                        autocomplete="off"
                        maxlength="30"
                    >
                    <button id="saveNameButton" class="save-name-button">Save</button>
                </div>
                <div class="current-name-display" id="currentNameDisplay" style="display: none;">
                    <span>Chatting as: <strong id="currentNameText"></strong></span>
                    <button id="changeNameButton" class="change-name-button">Change</button>
                </div>
            </div>
            <div class="input-wrapper">
                <input 
                    type="text" 
                    id="messageInput" 
                    class="message-input" 
                    placeholder="Type a message..."
                    autocomplete="off"
                    disabled
                >
                <label for="imageInput" class="image-upload-button" title="Upload Image">
                    üì∑
                </label>
                <input 
                    type="file" 
                    id="imageInput" 
                    accept="image/*"
                    style="display: none;"
                    disabled
                >
                <button id="sendButton" class="send-button" disabled>Send</button>
            </div>
            <div id="imagePreview" class="image-preview" style="display: none;">
                <img id="previewImage" src="" alt="Preview">
                <button id="removeImageButton" class="remove-image-button">‚úï</button>
            </div>
        </div>
    </div>

    <!-- Room Code Modal -->
    <div id="roomCodeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>Private Room Created!</h2>
            <p style="color: #b0b0b0; margin-bottom: 20px; text-align: center;">Share this code with your friends:</p>
            <div class="room-code-display-large">
                <span id="roomCodeDisplayText"></span>
                <button id="copyRoomCodeButton" class="copy-button" title="Copy code">üìã</button>
            </div>
            <button id="closeRoomCodeModal" class="modal-button" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <!-- Join Room Modal -->
    <div id="joinRoomModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>Join Private Room</h2>
            <input type="text" id="roomCodeInput" placeholder="Enter room code..." maxlength="6" pattern="[0-9]{6}">
            <div class="modal-buttons">
                <button id="confirmJoinButton" class="modal-button">Join</button>
                <button id="cancelJoinButton" class="modal-button modal-button-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Firebase
        let db = null;
        let messagesUnsubscribe = null;
        
        try {
            if (typeof firebaseConfig !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                console.log('Firebase connected successfully!');
            } else {
                console.warn('Firebase config not found. Using localStorage fallback.');
            }
        } catch (error) {
            console.error('Firebase initialization error:', error);
            console.warn('Falling back to localStorage.');
        }
        
        // Private Room Variables
        let currentRoomCode = null;

        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const userNameInput = document.getElementById('userNameInput');
        const saveNameButton = document.getElementById('saveNameButton');
        const currentNameDisplay = document.getElementById('currentNameDisplay');
        const currentNameText = document.getElementById('currentNameText');
        const changeNameButton = document.getElementById('changeNameButton');
        const nameInputWrapper = userNameInput.parentElement;
        
        // Room UI elements
        const createRoomButton = document.getElementById('createRoomButton');
        const joinRoomButton = document.getElementById('joinRoomButton');
        const leaveRoomButton = document.getElementById('leaveRoomButton');
        const roomCodeDisplay = document.getElementById('roomCodeDisplay');
        const currentRoomCodeDisplay = document.getElementById('currentRoomCodeDisplay');
        const roomCodeModal = document.getElementById('roomCodeModal');
        const roomCodeDisplayText = document.getElementById('roomCodeDisplayText');
        const copyRoomCodeButton = document.getElementById('copyRoomCodeButton');
        const closeRoomCodeModal = document.getElementById('closeRoomCodeModal');
        const joinRoomModal = document.getElementById('joinRoomModal');
        const roomCodeInput = document.getElementById('roomCodeInput');
        const confirmJoinButton = document.getElementById('confirmJoinButton');
        const cancelJoinButton = document.getElementById('cancelJoinButton');

        let currentUserName = '';
        let loadedMessageIds = new Set(); // Track loaded messages to prevent duplicates
        const MAX_VISIBLE_MESSAGES = 35; // Maximum number of messages to display
        let isInitialLoad = true; // Track if this is the first load
        let selectedImage = null; // Store selected image as base64

        // Load saved name from localStorage (still using localStorage for user name)
        function loadUserName() {
            const savedName = localStorage.getItem('jjnChatUserName');
            if (savedName && savedName.trim() !== '') {
                currentUserName = savedName.trim();
                showNameDisplay();
                enableChat();
            } else {
                showNameInput();
            }
        }

        // Save name to localStorage (still using localStorage for user name)
        function saveUserName(name) {
            const trimmedName = name.trim();
            if (trimmedName === '') return false;
            
            localStorage.setItem('jjnChatUserName', trimmedName);
            currentUserName = trimmedName;
            showNameDisplay();
            enableChat();
            return true;
        }

        // Show name input field
        function showNameInput() {
            nameInputWrapper.style.display = 'flex';
            currentNameDisplay.style.display = 'none';
            userNameInput.value = '';
            userNameInput.focus();
            disableChat();
        }

        // Show current name display
        function showNameDisplay() {
            nameInputWrapper.style.display = 'none';
            currentNameDisplay.style.display = 'flex';
            currentNameText.textContent = currentUserName;
        }

        // Enable chat input
        function enableChat() {
            messageInput.disabled = false;
            sendButton.disabled = false;
            document.getElementById('imageInput').disabled = false;
            messageInput.placeholder = 'Type a message...';
        }

        // Disable chat input
        function disableChat() {
            messageInput.disabled = true;
            sendButton.disabled = true;
            document.getElementById('imageInput').disabled = true;
            messageInput.placeholder = 'Enter your name above to start chatting...';
        }

        // Update room UI based on current room state
        function updateRoomUI() {
            if (currentRoomCode) {
                // In a room - show leave button and room code
                createRoomButton.style.display = 'none';
                joinRoomButton.style.display = 'none';
                leaveRoomButton.style.display = 'block';
                roomCodeDisplay.style.display = 'flex';
                currentRoomCodeDisplay.textContent = currentRoomCode;
            } else {
                // Not in a room - show create/join buttons
                createRoomButton.style.display = 'block';
                joinRoomButton.style.display = 'block';
                leaveRoomButton.style.display = 'none';
                roomCodeDisplay.style.display = 'none';
            }
        }
        
        // Load messages from Firestore or localStorage fallback
        function loadMessages() {
            // Check if user has a room code
            const savedRoom = localStorage.getItem('jjnChatRoomCode');
            if (savedRoom) {
                currentRoomCode = savedRoom;
            }
            
            // Update UI based on room state
            updateRoomUI();
            
            // Update welcome message
            const welcomeMsg = chatMessages.querySelector('.welcome-message');
            if (welcomeMsg) {
                if (currentRoomCode) {
                    welcomeMsg.querySelector('.message-content p').textContent = 'Welcome to Private Room ' + currentRoomCode + '!';
                } else {
                    welcomeMsg.querySelector('.message-content p').textContent = 'Welcome to JNJ Chat! Start a conversation below.';
                }
            }
            
            // Load messages
            if (db) {
                // Use Firestore with real-time updates
                loadMessagesFromFirestore(currentRoomCode);
            } else {
                // Fallback to localStorage
                const messages = JSON.parse(localStorage.getItem('jjnChatMessages') || '[]');
                // Filter by room code if in a room
                let filteredMessages = messages;
                if (currentRoomCode) {
                    filteredMessages = messages.filter(msg => msg.roomCode === currentRoomCode);
                } else {
                    filteredMessages = messages.filter(msg => !msg.roomCode);
                }
                // Only show the most recent messages
                const recentMessages = filteredMessages.slice(-MAX_VISIBLE_MESSAGES);
                recentMessages.forEach(msg => {
                    addMessageToChat(msg.user, msg.message, msg.timestamp, false, msg.image);
                });
                scrollToBottom();
            }
        }

        // Load messages from Firestore with real-time listener
        function loadMessagesFromFirestore(roomCode = null) {
            // Unsubscribe from previous listener
            if (messagesUnsubscribe) {
                messagesUnsubscribe();
            }
            
            // Clear existing messages (except welcome message) before loading
            const existingMessages = chatMessages.querySelectorAll('.message:not(.welcome-message)');
            existingMessages.forEach(msg => msg.remove());
            loadedMessageIds.clear();
            isInitialLoad = true;
            
            // Determine which collection to use
            const collection = roomCode ? 'roomMessages' : 'messages';
            let query = db.collection(collection);
            
            // If in a room, filter by room code first, then order
            if (roomCode) {
                query = query.where('roomCode', '==', roomCode).orderBy('timestamp', 'desc').limit(MAX_VISIBLE_MESSAGES);
            } else {
                query = query.orderBy('timestamp', 'desc').limit(MAX_VISIBLE_MESSAGES);
            }
            
            // Set up real-time listener that gets all current messages and then listens for changes
            messagesUnsubscribe = query.onSnapshot((querySnapshot) => {
                    // On initial load, clear and reload all messages
                    if (isInitialLoad) {
                        const messages = [];
                        querySnapshot.forEach((doc) => {
                            const data = doc.data();
                            // Double-check room code match for safety
                            if (roomCode) {
                                // Only include messages with matching room code
                                if (data.roomCode === roomCode) {
                                    messages.push({
                                        id: doc.id,
                                        user: data.user,
                                        message: data.message,
                                        timestamp: data.timestamp,
                                        image: data.image || null
                                    });
                                }
                            } else {
                                // Only include messages without roomCode in public chat
                                if (!data.roomCode) {
                                    messages.push({
                                        id: doc.id,
                                        user: data.user,
                                        message: data.message,
                                        timestamp: data.timestamp,
                                        image: data.image || null
                                    });
                                }
                            }
                        });
                        
                        // Display messages in reverse order (oldest first)
                        messages.reverse().forEach(msg => {
                            if (!loadedMessageIds.has(msg.id)) {
                                addMessageToChat(msg.user, msg.message, msg.timestamp, false, msg.image);
                                loadedMessageIds.add(msg.id);
                            }
                        });
                        scrollToBottom();
                        isInitialLoad = false;
                    } else {
                        // After initial load, only process new changes
                        querySnapshot.docChanges().forEach((change) => {
                            if (change.type === 'added' && !loadedMessageIds.has(change.doc.id)) {
                                const data = change.doc.data();
                                // Double-check room code match
                                if (roomCode) {
                                    if (data.roomCode === roomCode) {
                                        addMessageToChat(data.user, data.message, data.timestamp, false, data.image || null);
                                        loadedMessageIds.add(change.doc.id);
                                    }
                                } else {
                                    // Only show messages without roomCode in public chat
                                    if (!data.roomCode) {
                                        addMessageToChat(data.user, data.message, data.timestamp, false, data.image || null);
                                        loadedMessageIds.add(change.doc.id);
                                    }
                                }
                            }
                        });
                        scrollToBottom();
                    }
                }, (error) => {
                    console.error('Error in real-time listener:', error);
                    // Fallback to localStorage
                    const messages = JSON.parse(localStorage.getItem('jjnChatMessages') || '[]');
                    // Filter by room code if in a room
                    let filteredMessages = messages;
                    if (roomCode) {
                        filteredMessages = messages.filter(msg => msg.roomCode === roomCode);
                    } else {
                        filteredMessages = messages.filter(msg => !msg.roomCode);
                    }
                    // Only show the most recent messages
                    const recentMessages = filteredMessages.slice(-MAX_VISIBLE_MESSAGES);
                    recentMessages.forEach(msg => {
                        addMessageToChat(msg.user, msg.message, msg.timestamp, false, msg.image || null);
                    });
                    scrollToBottom();
                });
        }

        // Save message to Firestore or localStorage fallback
        function saveMessage(user, message, timestamp, imageData = null) {
            const messageData = {
                user: user,
                message: message,
                timestamp: timestamp
            };
            
            if (imageData) {
                messageData.image = imageData;
            }
            
            // Add room code if in a private room
            if (currentRoomCode) {
                messageData.roomCode = currentRoomCode;
            }
            
            if (db) {
                // Save to Firestore - use roomMessages collection if in a room
                const collection = currentRoomCode ? 'roomMessages' : 'messages';
                db.collection(collection).add(messageData)
                .then((docRef) => {
                    // Update the message element with the actual document ID
                    const messageElement = chatMessages.querySelector(`[data-message-id="temp-${timestamp}"]`);
                    if (messageElement) {
                        messageElement.setAttribute('data-message-id', docRef.id);
                    }
                })
                .catch((error) => {
                    console.error('Error saving message to Firestore:', error);
                    // Fallback to localStorage
                    saveMessageToLocalStorage(user, message, timestamp, imageData);
                });
            } else {
                // Fallback to localStorage
                saveMessageToLocalStorage(user, message, timestamp, imageData);
            }
        }

        // Fallback: Save messages to localStorage
        function saveMessageToLocalStorage(user, message, timestamp, imageData = null) {
            const messages = JSON.parse(localStorage.getItem('jjnChatMessages') || '[]');
            const messageObj = { user, message, timestamp };
            if (imageData) {
                messageObj.image = imageData;
            }
            // Add room code if in a private room
            if (currentRoomCode) {
                messageObj.roomCode = currentRoomCode;
            }
            messages.push(messageObj);
            // Keep only last 100 messages
            if (messages.length > 100) {
                messages.shift();
            }
            localStorage.setItem('jjnChatMessages', JSON.stringify(messages));
        }

        // Add message to chat display
        function addMessageToChat(user, message, timestamp, shouldSave = true, imageData = null) {
            // Remove welcome message if it exists
            const welcomeMsg = chatMessages.querySelector('.welcome-message');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }

            if (shouldSave) {
                saveMessage(user, message, timestamp, imageData);
            }

            // Check if message already exists (prevent duplicates)
            const existingMessages = chatMessages.querySelectorAll('.message:not(.welcome-message)');
            for (let msg of existingMessages) {
                const msgTime = msg.getAttribute('data-timestamp');
                const msgUser = msg.querySelector('.message-user').textContent;
                const msgContent = msg.querySelector('.message-content p')?.textContent || '';
                const msgImage = msg.querySelector('.message-image');
                const hasImage = msgImage !== null;
                if (msgTime == timestamp && msgUser === user && msgContent === message && hasImage === !!imageData) {
                    return; // Message already exists, don't add duplicate
                }
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.setAttribute('data-timestamp', timestamp);
            // Add message ID for tracking
            if (shouldSave && db) {
                // We'll set this after saving, but for now use timestamp as ID
                messageDiv.setAttribute('data-message-id', 'temp-' + timestamp);
            }
            
            const time = new Date(timestamp);
            const timeString = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            let imageHtml = '';
            if (imageData) {
                const imageId = 'img-' + timestamp;
                imageHtml = `<div class="message-image"><img id="${imageId}" src="${imageData}" alt="Uploaded image" class="chat-image"></div>`;
            }
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-user">${escapeHtml(user)}</span>
                    <span class="message-time">${timeString}</span>
                </div>
                <div class="message-content">
                    ${imageHtml}
                    ${message ? `<p>${escapeHtml(message)}</p>` : ''}
                </div>
            `;
            
            // Add click handler for image expansion
            if (imageData) {
                const imageId = 'img-' + timestamp;
                const img = messageDiv.querySelector('#' + imageId);
                if (img) {
                    img.addEventListener('click', function() {
                        expandImage(this);
                    });
                }
            }
            
            // Insert message in correct chronological order
            const allMessages = Array.from(chatMessages.querySelectorAll('.message:not(.welcome-message)'));
            let inserted = false;
            for (let i = 0; i < allMessages.length; i++) {
                const msgTimestamp = parseInt(allMessages[i].getAttribute('data-timestamp') || '0');
                if (timestamp < msgTimestamp) {
                    chatMessages.insertBefore(messageDiv, allMessages[i]);
                    inserted = true;
                    break;
                }
            }
            if (!inserted) {
                chatMessages.appendChild(messageDiv);
            }
            
            // Remove old messages if we exceed the limit
            limitVisibleMessages();
            
            scrollToBottom();
        }

        // Limit visible messages to MAX_VISIBLE_MESSAGES
        function limitVisibleMessages() {
            const allMessages = chatMessages.querySelectorAll('.message:not(.welcome-message)');
            if (allMessages.length > MAX_VISIBLE_MESSAGES) {
                // Remove the oldest messages (first ones in the list)
                const messagesToRemove = allMessages.length - MAX_VISIBLE_MESSAGES;
                for (let i = 0; i < messagesToRemove; i++) {
                    allMessages[i].remove();
                }
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Scroll to bottom of chat
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Send message
        function sendMessage() {
            const message = messageInput.value.trim();
            if ((message === '' && !selectedImage) || !currentUserName) return;

            const timestamp = Date.now();
            const imageData = selectedImage;
            
            // Clear image preview
            if (selectedImage) {
                selectedImage = null;
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('previewImage').src = '';
                document.getElementById('imageInput').value = '';
            }
            
            if (db) {
                // Save to Firestore first
                saveMessage(currentUserName, message, timestamp, imageData);
                
                // Add to display immediately for better UX
                addMessageToChat(currentUserName, message, timestamp, false, imageData);
            } else {
                addMessageToChat(currentUserName, message, timestamp, true, imageData);
            }
            messageInput.value = '';
            messageInput.focus();
        }
        
        // Handle image selection
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Image is too large! Maximum size is 5MB.');
                event.target.value = '';
                return;
            }
            
            // Check if it's an image
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file.');
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                selectedImage = e.target.result; // Store as base64
                document.getElementById('previewImage').src = selectedImage;
                document.getElementById('imagePreview').style.display = 'flex';
            };
            reader.readAsDataURL(file);
        }
        
        // Remove selected image
        function removeImage() {
            selectedImage = null;
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('previewImage').src = '';
            document.getElementById('imageInput').value = '';
        }
        
        // Expand image on click
        function expandImage(imgElement) {
            // Remove any existing expanded image
            const existingExpanded = document.querySelector('.expanded-image-overlay');
            if (existingExpanded) {
                existingExpanded.remove();
            }
            
            // Create overlay
            const overlay = document.createElement('div');
            overlay.className = 'expanded-image-overlay';
            overlay.innerHTML = `
                <div class="expanded-image-container">
                    <button class="close-expanded-image">‚úï</button>
                    <img src="${imgElement.src}" alt="Expanded image" class="expanded-image">
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Close on overlay click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay || e.target.classList.contains('close-expanded-image')) {
                    overlay.remove();
                }
            });
            
            // Close on Escape key
            const closeHandler = (e) => {
                if (e.key === 'Escape') {
                    overlay.remove();
                    document.removeEventListener('keydown', closeHandler);
                }
            };
            document.addEventListener('keydown', closeHandler);
        }

        // Save name handler
        function handleSaveName() {
            const name = userNameInput.value.trim();
            if (name === '') {
                userNameInput.focus();
                return;
            }
            if (saveUserName(name)) {
                userNameInput.value = '';
            }
        }

        // Generate a 6-digit room code
        function generateRoomCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }
        
        // Create a private room
        function createRoom() {
            if (!currentUserName) {
                alert('Please enter your name first.');
                return;
            }
            
            const roomCode = generateRoomCode();
            currentRoomCode = roomCode;
            localStorage.setItem('jjnChatRoomCode', roomCode);
            
            // Update UI
            updateRoomUI();
            
            // Show modal with code to copy
            roomCodeDisplayText.textContent = roomCode;
            roomCodeModal.style.display = 'flex';
            
            // Clear chat and show welcome message for private room
            chatMessages.innerHTML = '<div class="message welcome-message"><div class="message-content"><p>Welcome to Private Room ' + roomCode + '!</p></div></div>';
            loadedMessageIds.clear();
            isInitialLoad = true;
            
            // Load messages for this room (will be empty initially)
            if (db) {
                loadMessagesFromFirestore(roomCode);
            } else {
                // Fallback: reload from localStorage with room filter
                loadMessages();
            }
        }
        
        // Join a private room
        function joinRoom() {
            if (!currentUserName) {
                alert('Please enter your name first.');
                return;
            }
            
            joinRoomModal.style.display = 'flex';
            roomCodeInput.focus();
        }
        
        // Confirm join room
        function confirmJoin() {
            const code = roomCodeInput.value.trim();
            if (code.length === 6 && /^\d+$/.test(code)) {
                currentRoomCode = code;
                localStorage.setItem('jjnChatRoomCode', code);
                
                // Update UI
                updateRoomUI();
                
                // Close modal
                joinRoomModal.style.display = 'none';
                roomCodeInput.value = '';
                
                // Clear chat and show welcome message for private room
                chatMessages.innerHTML = '<div class="message welcome-message"><div class="message-content"><p>Welcome to Private Room ' + code + '!</p></div></div>';
                loadedMessageIds.clear();
                isInitialLoad = true;
                
                // Load messages for this room
                if (db) {
                    loadMessagesFromFirestore(code);
                } else {
                    // Fallback: reload from localStorage with room filter
                    loadMessages();
                }
            } else {
                alert('Please enter a valid 6-digit room code.');
            }
        }
        
        // Leave private room and return to public chat
        function leaveRoom() {
            if (!confirm('Leave this private room and return to public chat?')) {
                return;
            }
            
            currentRoomCode = null;
            localStorage.removeItem('jjnChatRoomCode');
            
            // Update UI
            updateRoomUI();
            
            // Clear chat and show welcome message for public chat
            chatMessages.innerHTML = '<div class="message welcome-message"><div class="message-content"><p>Welcome to JNJ Chat! Start a conversation below.</p></div></div>';
            loadedMessageIds.clear();
            isInitialLoad = true;
            
            // Load public messages
            if (db) {
                loadMessagesFromFirestore(null);
            } else {
                // Fallback: reload from localStorage
                loadMessages();
            }
        }
        
        // Copy room code to clipboard
        function copyRoomCode() {
            const code = roomCodeDisplayText.textContent;
            navigator.clipboard.writeText(code).then(() => {
                copyRoomCodeButton.textContent = '‚úì';
                copyRoomCodeButton.style.background = 'rgba(81, 207, 102, 0.3)';
                setTimeout(() => {
                    copyRoomCodeButton.textContent = 'üìã';
                    copyRoomCodeButton.style.background = '';
                }, 2000);
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = code;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                copyRoomCodeButton.textContent = '‚úì';
                setTimeout(() => {
                    copyRoomCodeButton.textContent = 'üìã';
                }, 2000);
            });
        }
        
        // Event listeners
        saveNameButton.addEventListener('click', handleSaveName);
        userNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSaveName();
            }
        });
        changeNameButton.addEventListener('click', showNameInput);
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        document.getElementById('imageInput').addEventListener('change', handleImageSelect);
        document.getElementById('removeImageButton').addEventListener('click', removeImage);
        
        // Room event listeners
        createRoomButton.addEventListener('click', createRoom);
        joinRoomButton.addEventListener('click', joinRoom);
        leaveRoomButton.addEventListener('click', leaveRoom);
        copyRoomCodeButton.addEventListener('click', copyRoomCode);
        closeRoomCodeModal.addEventListener('click', () => {
            roomCodeModal.style.display = 'none';
        });
        confirmJoinButton.addEventListener('click', confirmJoin);
        cancelJoinButton.addEventListener('click', () => {
            joinRoomModal.style.display = 'none';
            roomCodeInput.value = '';
        });
        roomCodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                confirmJoin();
            }
        });
        roomCodeModal.addEventListener('click', (e) => {
            if (e.target === roomCodeModal) {
                roomCodeModal.style.display = 'none';
            }
        });
        joinRoomModal.addEventListener('click', (e) => {
            if (e.target === joinRoomModal) {
                joinRoomModal.style.display = 'none';
                roomCodeInput.value = '';
            }
        });

        // Initialize on page load
        loadUserName();
        loadMessages();
        
        // Cursor Trail Effect - Smooth line effect
        const trails = [];
        const maxTrails = 50;
        let lastTime = 0;
        
        function createCursorTrail(x, y, delay = 0) {
            setTimeout(() => {
                const trail = document.createElement('div');
                trail.className = 'cursor-trail';
                trail.style.left = x + 'px';
                trail.style.top = y + 'px';
                trail.style.opacity = '0.6';
                document.body.appendChild(trail);
                
                requestAnimationFrame(() => {
                    trail.style.opacity = '0';
                    trail.style.transform = 'translate(-50%, -50%) scale(0.2)';
                });
                
                setTimeout(() => {
                    if (trail.parentNode) {
                        trail.remove();
                    }
                }, 800);
                
                trails.push(trail);
                if (trails.length > maxTrails) {
                    const oldTrail = trails.shift();
                    if (oldTrail && oldTrail.parentNode) {
                        oldTrail.remove();
                    }
                }
            }, delay);
        }
        
        let lastX = 0;
        let lastY = 0;
        let mouseX = 0;
        let mouseY = 0;
        
        document.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
            
            const now = Date.now();
            const timeSinceLastTrail = now - lastTime;
            
            if (timeSinceLastTrail > 8) {
                const distance = Math.sqrt(
                    Math.pow(mouseX - lastX, 2) + Math.pow(mouseY - lastY, 2)
                );
                
                if (distance > 2) {
                    createCursorTrail(mouseX, mouseY);
                    lastX = mouseX;
                    lastY = mouseY;
                    lastTime = now;
                }
            }
        });
    </script>
</body>
</html>

