<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asteroids Game - JNJ Website</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="game.css">
    <link rel="stylesheet" href="animated-background.css">
    <script src="page-transitions.js" defer></script>
    <script src="animated-background.js" defer></script>
</head>
<body>
    <a href="index.html" class="back-button">‚Üê Back to Home</a>
    
    <div class="game-wrapper">
        <div class="game-ui">
            <div class="ui-left">
                <div id="score">Score: 0</div>
                <div id="highScore">High Score: 0</div>
                <div id="combo" class="combo-display" style="display: none;">COMBO x<span id="comboCount">1</span>!</div>
            </div>
            <div class="ui-center">
                <div id="level">Level 1</div>
                <div id="lives">Lives: ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                <div id="powerUp" class="power-up-display" style="display: none;">
                    <span id="powerUpText"></span>
                    <div class="power-up-timer">
                        <div class="power-up-bar" id="powerUpBar"></div>
                    </div>
                </div>
                <div id="bossWarning" class="boss-warning" style="display: none;">
                    <div class="boss-warning-text">‚ö†Ô∏è BOSS INCOMING! ‚ö†Ô∏è</div>
                </div>
                <div id="killStreak" class="kill-streak" style="display: none;">
                    <span id="killStreakText">üî• KILL STREAK!</span>
                </div>
            </div>
            <div class="ui-right">
                <button id="pauseBtn" class="ui-button">‚è∏ Pause</button>
                <button id="soundBtn" class="ui-button sound-btn">üîä Sound</button>
                <button id="leaderboardBtn" class="ui-button">üèÜ Leaderboard</button>
                <button id="achievementsBtn" class="ui-button">‚≠ê Achievements</button>
            </div>
        </div>
        
        <div class="game-instructions">
            <p><strong>Controls:</strong> ‚Üê ‚Üí Rotate | ‚Üë Thrust | Space Shoot | P Pause</p>
            <p id="gameModeDisplay" style="margin-top: 5px; font-size: 12px; opacity: 0.8;"></p>
        </div>
        
        <canvas id="gameCanvas"></canvas>
        
        <!-- Mode Selection Screen -->
        <div id="modeSelectionScreen" class="mode-selection-screen">
            <div class="mode-selection-content">
                <h1>üöÄ Asteroids</h1>
                <h2>Select Game Mode</h2>
                <div class="mode-buttons">
                    <button class="mode-button" data-mode="classic">
                        <div class="mode-icon">üéÆ</div>
                        <div class="mode-name">Classic</div>
                        <div class="mode-desc">Standard gameplay with lives and levels</div>
                    </button>
                    <button class="mode-button" data-mode="hardcore">
                        <div class="mode-icon">üíÄ</div>
                        <div class="mode-name">Hardcore</div>
                        <div class="mode-desc">One life, no power-ups, faster asteroids</div>
                    </button>
                    <button class="mode-button" data-mode="endless">
                        <div class="mode-icon">‚ôæÔ∏è</div>
                        <div class="mode-name">Endless</div>
                        <div class="mode-desc">Infinite levels, increasing difficulty</div>
                    </button>
                    <button class="mode-button" data-mode="survival">
                        <div class="mode-icon">‚è±Ô∏è</div>
                        <div class="mode-name">Survival</div>
                        <div class="mode-desc">Survive as long as possible, time-based</div>
                    </button>
                </div>
            </div>
        </div>
        
        <div id="gameOverScreen" class="game-over-screen" style="display: none;">
            <div class="game-over-content">
                <h2>Game Over!</h2>
                <p class="final-score">Final Score: <span id="finalScore">0</span></p>
                <p class="high-score-text">High Score: <span id="finalHighScore">0</span></p>
                <p class="level-reached">Level Reached: <span id="finalLevel">1</span></p>
                <p class="asteroids-destroyed">Asteroids Destroyed: <span id="finalAsteroids">0</span></p>
                <div id="newAchievements" class="new-achievements" style="display: none;">
                    <h3>üéâ New Achievements Unlocked!</h3>
                    <div id="newAchievementsList"></div>
                </div>
                <div class="game-over-buttons">
                    <button id="restartBtn" class="restart-button">üîÑ Play Again</button>
                    <button id="mainMenuBtn" class="restart-button">üè† Main Menu</button>
                </div>
            </div>
        </div>
        
        <div id="pauseScreen" class="pause-screen" style="display: none;">
            <div class="pause-content">
                <h2>‚è∏ Paused</h2>
                <p>Press P to resume</p>
                <button id="mainMenuFromPauseBtn" class="restart-button" style="margin-top: 20px;">üè† Main Menu</button>
            </div>
        </div>
        
        <div id="levelComplete" class="level-complete" style="display: none;">
            <div class="level-complete-content">
                <h2>Level Complete!</h2>
                <p>Bonus: <span id="levelBonus">0</span> points</p>
            </div>
        </div>
        
        <!-- Leaderboard Screen -->
        <div id="leaderboardScreen" class="leaderboard-screen" style="display: none;">
            <div class="leaderboard-content">
                <h2>üèÜ Leaderboard</h2>
                <div class="leaderboard-tabs">
                    <button class="tab-button active" data-tab="all">All</button>
                    <button class="tab-button" data-tab="classic">Classic</button>
                    <button class="tab-button" data-tab="hardcore">Hardcore</button>
                    <button class="tab-button" data-tab="endless">Endless</button>
                    <button class="tab-button" data-tab="survival">Survival</button>
                </div>
                <div id="leaderboardList" class="leaderboard-list"></div>
                <button id="closeLeaderboardBtn" class="restart-button">Close</button>
            </div>
        </div>
        
        <!-- Achievements Screen -->
        <div id="achievementsScreen" class="achievements-screen" style="display: none;">
            <div class="achievements-content">
                <h2>‚≠ê Achievements</h2>
                <div id="achievementsList" class="achievements-list"></div>
                <button id="closeAchievementsBtn" class="restart-button">Close</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // Game Mode
        // Hardcore 2 mode (global flag for all games) - PERSISTENT FOREVER
        let hardcore2Global = localStorage.getItem('hardcore2Global') === 'true';
        
        // If hardcore2Global is active, always start in hardcore2 mode
        let gameMode = hardcore2Global ? 'hardcore2' : 'classic'; // classic, hardcore, endless, survival, hardcore2
        let gameStartTime = 0;
        let survivalTime = 0;
        let lastSurvivalSpawn = 0; // Track last asteroid spawn time in survival mode
        
        // Log on page load if Hardcore 2 is active
        if (hardcore2Global) {
            console.log('üî• HARDCORE 2 MODE PERSISTENT - Active in Asteroids game (ALWAYS ON)');
        }
        let spaceHoldStartTime = 0;
        let spaceHeld = false;
        const SPACE_HOLD_TIME = 2000; // 2 seconds to activate hardcore 2
        
        let score = 0;
        let highScore = parseInt(localStorage.getItem('asteroidsHighScore') || '0');
        let level = 1;
        let lives = 3;
        let isPaused = false;
        let isGameOver = false;
        let particles = [];
        let stars = [];
        let powerUps = [];
        let screenShake = { x: 0, y: 0, intensity: 0 };
        let comboCount = 0;
        let comboTime = 0;
        let lastKillTime = 0;
        let activePowerUp = null;
        let powerUpTime = 0;
        let asteroidsDestroyed = 0;
        let soundEnabled = true;
        let bossAsteroid = null;
        let bossSpawned = false;
        let levelCompletePending = false;
        let killStreak = 0;
        let lastKillStreakTime = 0;
        
        // Leaderboard System
        function getLeaderboard() {
            return JSON.parse(localStorage.getItem('asteroidsLeaderboard') || '[]');
        }
        
        function saveToLeaderboard(entry) {
            const leaderboard = getLeaderboard();
            leaderboard.push(entry);
            leaderboard.sort((a, b) => b.score - a.score);
            // Keep top 50 entries
            if (leaderboard.length > 50) {
                leaderboard.splice(50);
            }
            localStorage.setItem('asteroidsLeaderboard', JSON.stringify(leaderboard));
        }
        
        function displayLeaderboard(mode = 'all') {
            const leaderboard = getLeaderboard();
            const filtered = mode === 'all' ? leaderboard : leaderboard.filter(e => e.mode === mode);
            const list = document.getElementById('leaderboardList');
            list.innerHTML = '';
            
            if (filtered.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">No scores yet. Be the first!</p>';
                return;
            }
            
            filtered.slice(0, 20).forEach((entry, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                item.innerHTML = `
                    <div class="leaderboard-rank">#${index + 1}</div>
                    <div class="leaderboard-info">
                        <div class="leaderboard-score">${entry.score.toLocaleString()}</div>
                        <div class="leaderboard-details">
                            <span class="leaderboard-mode">${entry.mode.toUpperCase()}</span>
                            <span>‚Ä¢</span>
                            <span>Level ${entry.level}</span>
                            <span>‚Ä¢</span>
                            <span>${entry.asteroidsDestroyed} destroyed</span>
                        </div>
                    </div>
                    <div class="leaderboard-date">${new Date(entry.date).toLocaleDateString()}</div>
                `;
                list.appendChild(item);
            });
        }
        
        // Achievements System
        const achievements = [
            { id: 'first_blood', name: 'First Blood', desc: 'Destroy your first asteroid', icon: 'üéØ', unlocked: false },
            { id: 'century', name: 'Century Club', desc: 'Reach 100 points', icon: 'üíØ', unlocked: false },
            { id: 'thousand', name: 'Thousandaire', desc: 'Reach 1,000 points', icon: 'üí∞', unlocked: false },
            { id: 'ten_thousand', name: 'Ten Thousand', desc: 'Reach 10,000 points', icon: 'üíé', unlocked: false },
            { id: 'level_5', name: 'Level 5', desc: 'Reach level 5', icon: '‚≠ê', unlocked: false },
            { id: 'level_10', name: 'Level 10', desc: 'Reach level 10', icon: 'üåü', unlocked: false },
            { id: 'level_20', name: 'Level 20', desc: 'Reach level 20', icon: '‚ú®', unlocked: false },
            { id: 'boss_killer', name: 'Boss Killer', desc: 'Defeat a boss asteroid', icon: 'üëπ', unlocked: false },
            { id: 'combo_master', name: 'Combo Master', desc: 'Get a 10x combo', icon: 'üî•', unlocked: false },
            { id: 'survivor', name: 'Survivor', desc: 'Survive for 5 minutes', icon: '‚è±Ô∏è', unlocked: false },
            { id: 'asteroid_hunter', name: 'Asteroid Hunter', desc: 'Destroy 100 asteroids', icon: 'üéØ', unlocked: false },
            { id: 'asteroid_slayer', name: 'Asteroid Slayer', desc: 'Destroy 500 asteroids', icon: '‚öîÔ∏è', unlocked: false },
            { id: 'hardcore_warrior', name: 'Hardcore Warrior', desc: 'Complete hardcore mode', icon: 'üíÄ', unlocked: false },
            { id: 'endless_runner', name: 'Endless Runner', desc: 'Reach level 15 in endless mode', icon: '‚ôæÔ∏è', unlocked: false },
            { id: 'power_up_collector', name: 'Power-Up Collector', desc: 'Collect 10 power-ups', icon: '‚ö°', unlocked: false },
            { id: 'perfect_level', name: 'Perfect Level', desc: 'Complete a level without taking damage', icon: 'üõ°Ô∏è', unlocked: false },
        ];
        
        let powerUpsCollected = 0;
        let levelsWithoutDamage = 0;
        let currentLevelStartLives = 3;
        
        function getAchievements() {
            const saved = localStorage.getItem('asteroidsAchievements');
            if (saved) {
                const savedIds = JSON.parse(saved);
                achievements.forEach(ach => {
                    ach.unlocked = savedIds.includes(ach.id);
                });
            }
            return achievements;
        }
        
        function unlockAchievement(id) {
            const achievement = achievements.find(a => a.id === id);
            if (achievement && !achievement.unlocked) {
                achievement.unlocked = true;
                const saved = JSON.parse(localStorage.getItem('asteroidsAchievements') || '[]');
                if (!saved.includes(id)) {
                    saved.push(id);
                    localStorage.setItem('asteroidsAchievements', JSON.stringify(saved));
                    return achievement;
                }
            }
            return null;
        }
        
        function checkAchievements() {
            const newlyUnlocked = [];
            
            // Score-based achievements
            if (score >= 100 && unlockAchievement('century')) newlyUnlocked.push(achievements.find(a => a.id === 'century'));
            if (score >= 1000 && unlockAchievement('thousand')) newlyUnlocked.push(achievements.find(a => a.id === 'thousand'));
            if (score >= 10000 && unlockAchievement('ten_thousand')) newlyUnlocked.push(achievements.find(a => a.id === 'ten_thousand'));
            
            // Level-based achievements
            if (level >= 5 && unlockAchievement('level_5')) newlyUnlocked.push(achievements.find(a => a.id === 'level_5'));
            if (level >= 10 && unlockAchievement('level_10')) newlyUnlocked.push(achievements.find(a => a.id === 'level_10'));
            if (level >= 20 && unlockAchievement('level_20')) newlyUnlocked.push(achievements.find(a => a.id === 'level_20'));
            
            // Combo achievements
            if (comboCount >= 10 && unlockAchievement('combo_master')) newlyUnlocked.push(achievements.find(a => a.id === 'combo_master'));
            
            // Asteroid count achievements
            if (asteroidsDestroyed >= 100 && unlockAchievement('asteroid_hunter')) newlyUnlocked.push(achievements.find(a => a.id === 'asteroid_hunter'));
            if (asteroidsDestroyed >= 500 && unlockAchievement('asteroid_slayer')) newlyUnlocked.push(achievements.find(a => a.id === 'asteroid_slayer'));
            
            // Mode-specific achievements
            if (gameMode === 'hardcore' && level >= 5 && unlockAchievement('hardcore_warrior')) {
                newlyUnlocked.push(achievements.find(a => a.id === 'hardcore_warrior'));
            }
            if (gameMode === 'endless' && level >= 15 && unlockAchievement('endless_runner')) {
                newlyUnlocked.push(achievements.find(a => a.id === 'endless_runner'));
            }
            
            // Power-up achievements
            if (powerUpsCollected >= 10 && unlockAchievement('power_up_collector')) {
                newlyUnlocked.push(achievements.find(a => a.id === 'power_up_collector'));
            }
            
            // Survival time achievement
            if (gameMode === 'survival' && survivalTime >= 300 && unlockAchievement('survivor')) {
                newlyUnlocked.push(achievements.find(a => a.id === 'survivor'));
            }
            
            return newlyUnlocked;
        }
        
        function displayAchievements() {
            const list = document.getElementById('achievementsList');
            list.innerHTML = '';
            const unlocked = getAchievements();
            
            unlocked.forEach(ach => {
                const item = document.createElement('div');
                item.className = `achievement-item ${ach.unlocked ? 'unlocked' : 'locked'}`;
                item.innerHTML = `
                    <div class="achievement-icon">${ach.unlocked ? ach.icon : 'üîí'}</div>
                    <div class="achievement-info">
                        <div class="achievement-name">${ach.name}</div>
                        <div class="achievement-desc">${ach.desc}</div>
                    </div>
                    ${ach.unlocked ? '<div class="achievement-badge">‚úì</div>' : ''}
                `;
                list.appendChild(item);
            });
        }

        // Audio context for sound effects
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(frequency, duration, type = 'sine', volume = 0.1) {
            if (!soundEnabled) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = type;
            
            gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        // Initialize stars
        for (let i = 0; i < 200; i++) {
            stars.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                size: Math.random() * 2.5 + 0.5,
                speed: Math.random() * 1 + 0.2,
                brightness: Math.random(),
                twinkle: Math.random() * Math.PI * 2
            });
        }

        // Ship
        const ship = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            radius: 20,
            angle: -Math.PI / 2,
            rotation: 0,
            speed: 0,
            maxSpeed: 4,
            thrust: 0,
            bullets: [],
            invulnerable: false,
            invulnerableTime: 0,
            shield: false,
            shieldTime: 0,
            trail: []
        };

        // Asteroids
        let asteroids = [];
        const asteroidSizes = [80, 50, 30];

        function createAsteroid(x, y, radius, avoidShip = false, isBoss = false) {
            // Ensure valid coordinates
            if (!x || !y) {
                x = Math.random() * canvas.width;
                y = Math.random() * canvas.height;
            }
            
            // If avoiding ship, ensure safe distance
            if (avoidShip) {
                let attempts = 0;
                while (attempts < 20) {
                    const dist = Math.sqrt((x - ship.x) ** 2 + (y - ship.y) ** 2);
                    if (dist > 200) break; // Safe distance
                    x = Math.random() * canvas.width;
                    y = Math.random() * canvas.height;
                    attempts++;
                }
            }
            
            // Calculate speed based on game mode
            let speedMultiplier = 1;
            if (gameMode === 'hardcore2') {
                speedMultiplier = 3.0; // 3x faster - MUCH harder!
            } else if (gameMode === 'hardcore') {
                speedMultiplier = 1.5; // 50% faster
            } else if (gameMode === 'survival') {
                // Get survival time for speed calculation
                const currentSurvivalTime = Math.floor((Date.now() - gameStartTime) / 1000);
                speedMultiplier = 1 + (currentSurvivalTime / 300); // Gets faster over time
            } else if (gameMode === 'endless') {
                speedMultiplier = 1 + (level * 0.1); // Gets faster each level
            }
            
            let a = {
                x: x || Math.random() * canvas.width,
                y: y || Math.random() * canvas.height,
                radius: radius,
                dx: (Math.random() - 0.5) * (2 + level * (gameMode === 'hardcore2' ? 0.5 : 0.3)) * speedMultiplier,
                dy: (Math.random() - 0.5) * (2 + level * (gameMode === 'hardcore2' ? 0.5 : 0.3)) * speedMultiplier,
                rotation: (Math.random() - 0.5) * 0.1,
                rotationSpeed: (Math.random() - 0.5) * 0.08,
                vertices: [],
                isBoss: isBoss,
                health: isBoss ? (gameMode === 'hardcore2' ? 10 : 5) : (gameMode === 'hardcore2' ? 2 : 1), // Hardcore 2: asteroids need 2 hits, boss needs 10
                maxHealth: isBoss ? (gameMode === 'hardcore2' ? 10 : 5) : (gameMode === 'hardcore2' ? 2 : 1)
            };
            
            const numVertices = isBoss ? 16 : (8 + Math.floor(Math.random() * 4));
            for (let i = 0; i < numVertices; i++) {
                const angle = (Math.PI * 2 / numVertices) * i;
                const distance = radius * (0.7 + Math.random() * 0.3);
                a.vertices.push({
                    x: Math.cos(angle) * distance,
                    y: Math.sin(angle) * distance
                });
            }
            
            if (isBoss) {
                bossAsteroid = a;
            } else {
                asteroids.push(a);
            }
        }

        function initLevel() {
            // Clear all asteroids and bullets first
            asteroids = [];
            ship.bullets = [];
            if (gameMode === 'hardcore' || gameMode === 'hardcore2') {
                powerUps = []; // No power-ups in hardcore/hardcore2
            } else {
                powerUps = [];
            }
            particles = [];
            
            bossAsteroid = null;
            bossSpawned = false;
            levelCompletePending = false;
            
            // Reset ship position to center
            ship.x = canvas.width / 2;
            ship.y = canvas.height / 2;
            ship.speed = 0;
            ship.angle = -Math.PI / 2;
            
            // Give brief invulnerability at level start
            ship.invulnerable = true;
            // Hardcore 2: Less invulnerability time at level start
            ship.invulnerableTime = gameMode === 'hardcore2' ? 90 : 180;
            
            // Track starting lives for perfect level achievement
            currentLevelStartLives = lives;
            
            // Calculate number of asteroids based on mode
            let numAsteroids;
            if (gameMode === 'hardcore2') {
                // Hardcore 2: Triple asteroid spawn - MUCH harder!
                numAsteroids = Math.min((4 + Math.floor(level * 0.7)) * 3, 30);
            } else if (gameMode === 'hardcore') {
                numAsteroids = Math.min(4 + Math.floor(level * 0.7), 10); // More asteroids
            } else if (gameMode === 'endless') {
                numAsteroids = Math.min(3 + Math.floor(level * 0.6), 12); // More for endless
            } else if (gameMode === 'survival') {
                // Survival mode: start with 3 asteroids, more spawn over time
                numAsteroids = 3;
            } else {
                numAsteroids = Math.min(3 + Math.floor(level * 0.5), 8); // Classic
            }
            
            // Spawn asteroids away from ship
            let attempts = 0;
            for (let i = 0; i < numAsteroids; i++) {
                let x, y;
                let validPosition = false;
                attempts = 0;
                
                // Try to find a safe spawn position
                while (!validPosition && attempts < 50) {
                    x = Math.random() * canvas.width;
                    y = Math.random() * canvas.height;
                    
                    // Check distance from ship
                    const dist = Math.sqrt((x - ship.x) ** 2 + (y - ship.y) ** 2);
                    if (dist > 200) { // Safe distance from ship
                        validPosition = true;
                    }
                    attempts++;
                }
                
                // If we couldn't find a safe position, spawn at edges
                if (!validPosition) {
                    const side = Math.floor(Math.random() * 4);
                    switch(side) {
                        case 0: x = 0; y = Math.random() * canvas.height; break;
                        case 1: x = canvas.width; y = Math.random() * canvas.height; break;
                        case 2: x = Math.random() * canvas.width; y = 0; break;
                        case 3: x = Math.random() * canvas.width; y = canvas.height; break;
                    }
                }
                
                createAsteroid(x, y, asteroidSizes[0], false);
            }
        }

        initLevel();

        // Power-up types
        const PowerUpTypes = {
            RAPID_FIRE: 'rapid-fire',
            SHIELD: 'shield',
            MULTI_SHOT: 'multi-shot',
            SLOW_MO: 'slow-mo',
            EXPLOSIVE: 'explosive',
            HOMING: 'homing',
            LASER: 'laser',
            EXTRA_LIFE: 'extra-life'
        };

        function createPowerUp(x, y) {
            if (gameMode === 'hardcore') return; // No power-ups in hardcore mode
            if (gameMode === 'hardcore2') {
                // Hardcore 2: Only explosion power-up, lower chance
                if (Math.random() > 0.15) return; // 15% chance
                powerUps.push({
                    x: x,
                    y: y,
                    type: PowerUpTypes.EXPLOSIVE,
                    rotation: 0,
                    rotationSpeed: 0.05,
                    life: 600,
                    pulse: 0
                });
                return;
            }
            if (Math.random() > 0.25) return; // 25% chance
            
            const types = Object.values(PowerUpTypes);
            const type = types[Math.floor(Math.random() * types.length)];
            
            powerUps.push({
                x: x,
                y: y,
                type: type,
                rotation: 0,
                rotationSpeed: 0.05,
                life: 600,
                pulse: 0
            });
        }

        function activatePowerUp(type) {
            if (gameMode === 'hardcore') return; // No power-ups in hardcore
            if (gameMode === 'hardcore2' && type !== PowerUpTypes.EXPLOSIVE) return; // Only explosive in hardcore 2
            
            activePowerUp = type;
            powerUpTime = 600;
            powerUpsCollected++;
            
            switch(type) {
                case PowerUpTypes.SHIELD:
                    ship.shield = true;
                    ship.shieldTime = 600;
                    break;
                case PowerUpTypes.EXTRA_LIFE:
                    lives++;
                    updateLivesDisplay();
                    createParticles(ship.x, ship.y, '#51cf66', 30, 5, 5);
                    playSound(500, 0.3, 'sine', 0.2);
                    return; // Don't set activePowerUp for extra life
            }
            
            playSound(400, 0.2, 'sine', 0.15);
            updatePowerUpDisplay();
        }

        function updatePowerUpDisplay() {
            const display = document.getElementById('powerUp');
            const text = document.getElementById('powerUpText');
            const bar = document.getElementById('powerUpBar');
            
            if (activePowerUp && powerUpTime > 0) {
                display.style.display = 'block';
                const names = {
                    'rapid-fire': '‚ö° Rapid Fire',
                    'shield': 'üõ°Ô∏è Shield',
                    'multi-shot': 'üî´ Multi Shot',
                    'slow-mo': '‚è±Ô∏è Slow Motion',
                    'explosive': 'üí• Explosive',
                    'homing': 'üéØ Homing',
                    'laser': '‚ö° Laser',
                    'extra-life': '‚ù§Ô∏è Extra Life'
                };
                text.textContent = names[activePowerUp] || activePowerUp;
                bar.style.width = (powerUpTime / 600 * 100) + '%';
            } else {
                display.style.display = 'none';
                activePowerUp = null;
                ship.shield = false;
            }
        }

        // Particles
        function createParticles(x, y, color, count = 15, speed = 4, size = 4) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: x,
                    y: y,
                    dx: (Math.random() - 0.5) * speed,
                    dy: (Math.random() - 0.5) * speed,
                    life: 50,
                    maxLife: 50,
                    size: Math.random() * size + 1,
                    color: color,
                    glow: Math.random() > 0.5,
                    rotation: Math.random() * Math.PI * 2,
                    rotationSpeed: (Math.random() - 0.5) * 0.2
                });
            }
        }

        function addScreenShake(intensity) {
            screenShake.intensity = Math.max(screenShake.intensity, intensity);
        }

        // Combo system
        function updateCombo() {
            const now = Date.now();
            if (now - lastKillTime < 2000) {
                comboCount++;
                comboTime = 120;
                killStreak++;
            } else {
                comboCount = 1;
                killStreak = 1;
            }
            lastKillTime = now;
            lastKillStreakTime = now;
            
            const comboDisplay = document.getElementById('combo');
            const comboCountDisplay = document.getElementById('comboCount');
            const killStreakDisplay = document.getElementById('killStreak');
            
            if (comboCount > 1) {
                comboDisplay.style.display = 'block';
                comboCountDisplay.textContent = comboCount;
                comboDisplay.style.animation = 'none';
                setTimeout(() => {
                    comboDisplay.style.animation = 'pulse 0.3s ease-out';
                }, 10);
                playSound(200 + comboCount * 50, 0.1, 'sine', 0.1);
            } else {
                comboDisplay.style.display = 'none';
            }
            
            // Kill streak display
            if (killStreak >= 5) {
                killStreakDisplay.style.display = 'block';
                killStreakDisplay.style.animation = 'none';
                setTimeout(() => {
                    killStreakDisplay.style.animation = 'pulse 0.5s ease-out';
                }, 10);
            } else {
                killStreakDisplay.style.display = 'none';
            }
        }

        // Key handling
        const keys = {};
        document.addEventListener("keydown", e => {
            keys[e.code] = true;
            if (e.code === "KeyP") {
                togglePause();
            }
            
            // Left+Space exploit to enable hardcore 2 globally - PERMANENTLY
            if (e.code === "ArrowLeft" && keys["Space"]) {
                hardcore2Global = true;
                localStorage.setItem('hardcore2Global', 'true');
                console.log('üî• HARDCORE 2 MODE ENABLED FOR ALL GAMES - PERMANENTLY SAVED!');
                alert('üî• HARDCORE 2 MODE ACTIVATED FOR ALL GAMES!\n\nThis will stay active forever until you clear your browser data.');
            }
            
            // Track Space hold for hardcore 2 activation
            if (e.code === "Space" && !spaceHeld) {
                spaceHoldStartTime = Date.now();
                spaceHeld = true;
            }
        });
        document.addEventListener("keyup", e => {
            keys[e.code] = false;
            
            // Reset space hold tracking
            if (e.code === "Space") {
                spaceHeld = false;
                spaceHoldStartTime = 0;
            }
        });

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        function togglePause() {
            if (isGameOver) return;
            isPaused = !isPaused;
            document.getElementById('pauseScreen').style.display = isPaused ? 'flex' : 'none';
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('soundBtn').textContent = soundEnabled ? 'üîä Sound' : 'üîá Muted';
        }

        function spawnBoss() {
            if (bossSpawned || bossAsteroid) return;
            
            bossSpawned = true;
            const warning = document.getElementById('bossWarning');
            warning.style.display = 'block';
            playSound(150, 0.5, 'sawtooth', 0.2);
            
            setTimeout(() => {
                warning.style.display = 'none';
                createAsteroid(canvas.width / 2, -100, 120, false, true);
                playSound(100, 0.3, 'square', 0.25);
            }, 2000);
        }

        function update() {
            // Always check localStorage for hardcore2Global state - enforce it if active
            const currentHardcore2State = localStorage.getItem('hardcore2Global') === 'true';
            if (currentHardcore2State) {
                hardcore2Global = true; // Sync local variable
                // ALWAYS force hardcore2 mode if global flag is active
                if (gameMode !== 'hardcore2') {
                    gameMode = 'hardcore2';
                    console.log('üî• HARDCORE 2 MODE ENFORCED (GLOBAL - PERSISTENT)!');
                    // Only reinitialize if game is running (not paused/over)
                    if (!isPaused && !isGameOver) {
                        initLevel();
                    }
                }
            }
            
            // Check for Space hold to activate hardcore 2 (only if not already in hardcore 2)
            if (spaceHeld && gameMode !== 'hardcore2' && !hardcore2Global) {
                const holdDuration = Date.now() - spaceHoldStartTime;
                if (holdDuration >= SPACE_HOLD_TIME) {
                    gameMode = 'hardcore2';
                    hardcore2Global = true;
                    localStorage.setItem('hardcore2Global', 'true');
                    console.log('üî• HARDCORE 2 MODE ACTIVATED!');
                    alert('üî• HARDCORE 2 MODE ACTIVATED!');
                    // Reset game for hardcore 2
                    initLevel();
                    spaceHeld = false; // Reset to prevent multiple activations
                }
            }
            
            if (isPaused || isGameOver) {
                requestAnimationFrame(update);
                return;
            }
            
            // Update survival time for survival mode
            if (gameMode === 'survival') {
                survivalTime = Math.floor((Date.now() - gameStartTime) / 1000);
                
                // Spawn more asteroids over time in survival mode
                // Spawn a new asteroid every 15 seconds, but limit total asteroids
                const targetAsteroids = Math.min(3 + Math.floor(survivalTime / 15), 15);
                if (asteroids.length < targetAsteroids && survivalTime > 0 && survivalTime >= lastSurvivalSpawn + 15) {
                    createAsteroid(null, null, asteroidSizes[0], true);
                    lastSurvivalSpawn = survivalTime;
                }
                
                // Update level display to show survival time
                const minutes = Math.floor(survivalTime / 60);
                const seconds = survivalTime % 60;
                document.getElementById("level").innerText = `Survival: ${minutes}:${seconds.toString().padStart(2, '0')}`;
            }

            // Spawn boss every 5 levels (only if level complete is not pending)
            if (level % 5 === 0 && !bossSpawned && asteroids.length === 0 && !bossAsteroid && !levelCompletePending && gameMode !== 'survival') {
                spawnBoss();
            }

            // Update screen shake
            if (screenShake.intensity > 0) {
                screenShake.x = (Math.random() - 0.5) * screenShake.intensity;
                screenShake.y = (Math.random() - 0.5) * screenShake.intensity;
                screenShake.intensity *= 0.9;
            } else {
                screenShake.x = 0;
                screenShake.y = 0;
            }

            // Update stars
            stars.forEach(star => {
                star.y += star.speed;
                star.twinkle += 0.05;
                if (star.y > canvas.height) {
                    star.y = 0;
                    star.x = Math.random() * canvas.width;
                }
            });

            // Update combo
            if (comboTime > 0) comboTime--;
            if (comboTime <= 0 && comboCount > 1) {
                comboCount = 0;
                document.getElementById('combo').style.display = 'none';
            }
            
            // Update kill streak
            const now = Date.now();
            if (now - lastKillStreakTime > 3000) {
                killStreak = 0;
                document.getElementById('killStreak').style.display = 'none';
            }

            // Update power-up
            if (powerUpTime > 0) {
                powerUpTime--;
                updatePowerUpDisplay();
            }

            // Ship rotation and thrust
            // Hardcore 2: Slower rotation for harder control
            const rotationSpeed = gameMode === 'hardcore2' ? 0.05 : 0.08;
            if (keys["ArrowLeft"]) ship.rotation = -rotationSpeed;
            else if (keys["ArrowRight"]) ship.rotation = rotationSpeed;
            else ship.rotation *= 0.9;

                    // Hardcore 2: Less thrust for harder control
                    const thrustPower = gameMode === 'hardcore2' ? 0.06 : 0.1;
                    if (keys["ArrowUp"]) {
                        ship.thrust = thrustPower;
                // Ship trail
                ship.trail.push({
                    x: ship.x - Math.cos(ship.angle) * 25,
                    y: ship.y - Math.sin(ship.angle) * 25,
                    life: 10
                });
                if (ship.trail.length > 5) ship.trail.shift();
                
                if (Math.random() > 0.5) {
                    const thrusterX = ship.x - Math.cos(ship.angle) * 25;
                    const thrusterY = ship.y - Math.sin(ship.angle) * 25;
                    createParticles(thrusterX, thrusterY, '#4a9eff', 4, 3, 3);
                }
            } else {
                ship.thrust = 0;
            }

            // Update trail
            ship.trail = ship.trail.filter(t => {
                t.life--;
                return t.life > 0;
            });

            ship.angle += ship.rotation;
            ship.speed += ship.thrust;
            // Hardcore 2: Use reduced max speed
            const maxSpeed = gameMode === 'hardcore2' ? 3.5 : ship.maxSpeed;
            ship.speed = Math.min(ship.speed, maxSpeed);
            ship.x += Math.cos(ship.angle) * ship.speed;
            ship.y += Math.sin(ship.angle) * ship.speed;
            
            // Hardcore 2: Less friction (harder to stop)
            ship.speed *= gameMode === 'hardcore2' ? 0.99 : 0.98;

            // Screen wrap
            if (ship.x < 0) ship.x = canvas.width;
            if (ship.x > canvas.width) ship.x = 0;
            if (ship.y < 0) ship.y = canvas.height;
            if (ship.y > canvas.height) ship.y = 0;

            // Update invulnerability
            if (ship.invulnerable) {
                ship.invulnerableTime--;
                if (ship.invulnerableTime <= 0) {
                    ship.invulnerable = false;
                }
            }

            if (ship.shield) {
                ship.shieldTime--;
                if (ship.shieldTime <= 0) {
                    ship.shield = false;
                }
            }

            // Shooting bullets
            const maxBullets = activePowerUp === PowerUpTypes.RAPID_FIRE ? 15 : 
                              activePowerUp === PowerUpTypes.LASER ? 3 : 8;
            const shootCooldown = activePowerUp === PowerUpTypes.RAPID_FIRE ? 3 : 
                                 activePowerUp === PowerUpTypes.LASER ? 5 : 10;
            
            if (keys["Space"] && ship.bullets.length < maxBullets) {
                const bulletSpeed = activePowerUp === PowerUpTypes.LASER ? 12 : 8;
                const shots = activePowerUp === PowerUpTypes.MULTI_SHOT ? 3 : 1;
                
                for (let i = 0; i < shots; i++) {
                    const angleOffset = shots > 1 ? (i - 1) * 0.3 : 0;
                    
                    // Find nearest asteroid for homing
                    let targetAsteroid = null;
                    if (activePowerUp === PowerUpTypes.HOMING && asteroids.length > 0) {
                        let minDist = Infinity;
                        asteroids.forEach(a => {
                            const dist = Math.sqrt((a.x - ship.x) ** 2 + (a.y - ship.y) ** 2);
                            if (dist < minDist) {
                                minDist = dist;
                                targetAsteroid = a;
                            }
                        });
                    }
                    
                    const bulletAngle = targetAsteroid ? 
                        Math.atan2(targetAsteroid.y - ship.y, targetAsteroid.x - ship.x) :
                        ship.angle + angleOffset;
                    
                    ship.bullets.push({
                        x: ship.x + Math.cos(bulletAngle) * 25,
                        y: ship.y + Math.sin(bulletAngle) * 25,
                        dx: Math.cos(bulletAngle) * bulletSpeed,
                        dy: Math.sin(bulletAngle) * bulletSpeed,
                        life: activePowerUp === PowerUpTypes.LASER ? 90 : 60,
                        explosive: activePowerUp === PowerUpTypes.EXPLOSIVE,
                        laser: activePowerUp === PowerUpTypes.LASER,
                        homing: activePowerUp === PowerUpTypes.HOMING,
                        target: targetAsteroid,
                        size: activePowerUp === PowerUpTypes.LASER ? 5 : 3
                    });
                }
                
                playSound(activePowerUp === PowerUpTypes.LASER ? 1000 : 800, 0.05, 'square', 0.1);
                if (shootCooldown > 0) {
                    keys["Space"] = false;
                }
            }

            // Update bullets
            ship.bullets = ship.bullets.filter(b => {
                // Homing bullet logic
                if (b.homing && b.target && asteroids.includes(b.target)) {
                    const dx = b.target.x - b.x;
                    const dy = b.target.y - b.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist > 0) {
                        const angle = Math.atan2(dy, dx);
                        const turnSpeed = 0.15;
                        const currentAngle = Math.atan2(b.dy, b.dx);
                        let newAngle = currentAngle;
                        
                        // Calculate angle difference
                        let angleDiff = angle - currentAngle;
                        while (angleDiff > Math.PI) angleDiff -= Math.PI * 2;
                        while (angleDiff < -Math.PI) angleDiff += Math.PI * 2;
                        
                        newAngle += Math.sign(angleDiff) * Math.min(Math.abs(angleDiff), turnSpeed);
                        
                        const speed = Math.sqrt(b.dx*b.dx + b.dy*b.dy);
                        b.dx = Math.cos(newAngle) * speed;
                        b.dy = Math.sin(newAngle) * speed;
                    }
                }
                
                b.x += b.dx;
                b.y += b.dy;
                b.life--;
                return b.life > 0 && b.x > -50 && b.x < canvas.width + 50 && b.y > -50 && b.y < canvas.height + 50;
            });

            // Update power-ups
            powerUps.forEach((pu, idx) => {
                pu.rotation += pu.rotationSpeed;
                pu.pulse += 0.1;
                pu.life--;
                
                const dx = ship.x - pu.x;
                const dy = ship.y - pu.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                if (dist < ship.radius + 15) {
                    activatePowerUp(pu.type);
                    createParticles(pu.x, pu.y, '#ffc107', 25, 5, 5);
                    powerUps.splice(idx, 1);
                }
            });
            powerUps = powerUps.filter(pu => pu.life > 0);

            // Update asteroids
            const slowMo = activePowerUp === PowerUpTypes.SLOW_MO ? 0.5 : 1;
            
            asteroids.forEach((a, i) => {
                a.x += a.dx * slowMo;
                a.y += a.dy * slowMo;
                a.rotation += a.rotationSpeed * slowMo;

                if (a.x < -a.radius) a.x = canvas.width + a.radius;
                if (a.x > canvas.width + a.radius) a.x = -a.radius;
                if (a.y < -a.radius) a.y = canvas.height + a.radius;
                if (a.y > canvas.height + a.radius) a.y = -a.radius;

                // Collision with ship
                if (!ship.invulnerable && !ship.shield) {
                    let dx = ship.x - a.x;
                    let dy = ship.y - a.y;
                    let dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < ship.radius + a.radius) {
                        lives--;
                        ship.invulnerable = true;
                        // Hardcore 2: Much less invulnerability time
                        ship.invulnerableTime = gameMode === 'hardcore2' ? 60 : 120;
                        addScreenShake(15);
                        createParticles(ship.x, ship.y, '#ff4d4d', 40, 6, 5);
                        playSound(150, 0.3, 'sawtooth', 0.2);
                        
                        if (lives <= 0) {
                            gameOver();
                            return;
                        }
                        
                        updateLivesDisplay();
                    }
                }

                // Bullet collision
                ship.bullets.forEach((b, j) => {
                    let dx = b.x - a.x;
                    let dy = b.y - a.y;
                    let dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < a.radius) {
                        // Hardcore 2: Double damage - asteroids need 2 hits
                        if (gameMode === 'hardcore2' && !a.isBoss) {
                            a.health--;
                            createParticles(a.x, a.y, '#ffc107', 15, 4, 3);
                            playSound(300, 0.1, 'square', 0.15);
                            ship.bullets.splice(j, 1);
                            
                            // Check if asteroid is destroyed
                            if (a.health <= 0) {
                                updateCombo();
                                const baseScore = Math.floor(100 / a.radius);
                                const comboMultiplier = comboCount;
                                const streakBonus = killStreak >= 10 ? 2 : killStreak >= 5 ? 1.5 : 1;
                                const points = Math.floor(baseScore * comboMultiplier * streakBonus);
                                score += points;
                                asteroidsDestroyed++;
                                
                                // Check first blood achievement
                                if (asteroidsDestroyed === 1) {
                                    unlockAchievement('first_blood');
                                }
                                
                                if (score > highScore) {
                                    highScore = score;
                                    localStorage.setItem('asteroidsHighScore', highScore.toString());
                                }
                                updateScore();
                                checkAchievements();
                                
                                addScreenShake(8);
                                createParticles(a.x, a.y, '#ffc107', 20, 5, 4);
                                asteroids.splice(i, 1);
                                createPowerUp(a.x, a.y);
                                
                                // Split asteroid
                                if (a.radius > 30 && asteroids.length < 20) {
                                    const newRadius = a.radius / 2;
                                    const offset1 = (Math.random() - 0.5) * 30;
                                    const offset2 = (Math.random() - 0.5) * 30;
                                    createAsteroid(a.x + offset1, a.y + offset2, newRadius, false);
                                    createAsteroid(a.x - offset1, a.y - offset2, newRadius, false);
                                }
                            }
                            return; // Don't process further for hardcore 2
                        }
                        
                        updateCombo();
                        const baseScore = Math.floor(100 / a.radius);
                        const comboMultiplier = comboCount;
                        const streakBonus = killStreak >= 10 ? 2 : killStreak >= 5 ? 1.5 : 1;
                        const points = Math.floor(baseScore * comboMultiplier * streakBonus);
                        score += points;
                        asteroidsDestroyed++;
                        
                        // Check first blood achievement
                        if (asteroidsDestroyed === 1) {
                            unlockAchievement('first_blood');
                        }
                        
                        if (score > highScore) {
                            highScore = score;
                            localStorage.setItem('asteroidsHighScore', highScore.toString());
                        }
                        updateScore();
                        
                        // Check achievements periodically
                        checkAchievements();
                        
                        addScreenShake(8);
                        playSound(300, 0.1, 'square', 0.15);
                        
                        // Explosive bullets
                        if (b.explosive) {
                            createParticles(a.x, a.y, '#ff4d4d', 30, 8, 6);
                            
                            // Hardcore 2: Explosions can one-shot you with larger radius
                            if (gameMode === 'hardcore2') {
                                const shipDist = Math.sqrt((ship.x - a.x) ** 2 + (ship.y - a.y) ** 2);
                                // Larger explosion radius in hardcore 2 (200 instead of 150)
                                if (shipDist < 200 && !ship.invulnerable && !ship.shield) {
                                    lives = 0;
                                    gameOver();
                                    return;
                                }
                            }
                            
                            // Damage nearby asteroids (but limit to prevent too many)
                            const nearbyAsteroids = [];
                            asteroids.forEach((otherA, oi) => {
                                if (oi !== i) {
                                    const odx = otherA.x - a.x;
                                    const ody = otherA.y - a.y;
                                    const odist = Math.sqrt(odx*odx + ody*ody);
                                    // Hardcore 2: Larger explosion radius
                                    const explosionRadius = gameMode === 'hardcore2' ? 150 : 100;
                                    if (odist < explosionRadius) {
                                        nearbyAsteroids.push(oi);
                                    }
                                }
                            });
                            
                            // Limit explosive chain to prevent too many asteroids
                            const maxChain = 3;
                            nearbyAsteroids.slice(0, maxChain).forEach(oi => {
                                createParticles(asteroids[oi].x, asteroids[oi].y, '#ffc107', 15, 5, 4);
                                asteroids.splice(oi, 1);
                                asteroidsDestroyed++;
                            });
                        } else {
                            createParticles(a.x, a.y, '#ffc107', 20, 5, 4);
                        }
                        
                        ship.bullets.splice(j, 1);
                        asteroids.splice(i, 1);

                        createPowerUp(a.x, a.y);

                        // Split asteroid (only if not too small and not too many asteroids)
                        if (a.radius > 30 && asteroids.length < 20) {
                            const newRadius = a.radius / 2;
                            const offset1 = (Math.random() - 0.5) * 30;
                            const offset2 = (Math.random() - 0.5) * 30;
                            createAsteroid(a.x + offset1, a.y + offset2, newRadius, false);
                            createAsteroid(a.x - offset1, a.y - offset2, newRadius, false);
                        }
                    }
                });
            });

            // Update boss asteroid
            if (bossAsteroid) {
                bossAsteroid.x += bossAsteroid.dx * slowMo;
                bossAsteroid.y += bossAsteroid.dy * slowMo;
                bossAsteroid.rotation += bossAsteroid.rotationSpeed * slowMo;

                // Boss movement pattern
                if (bossAsteroid.y < canvas.height * 0.3) {
                    bossAsteroid.dy = Math.abs(bossAsteroid.dy);
                }
                if (bossAsteroid.y > canvas.height * 0.7) {
                    bossAsteroid.dy = -Math.abs(bossAsteroid.dy);
                }

                // Wrap boss
                if (bossAsteroid.x < -bossAsteroid.radius) bossAsteroid.x = canvas.width + bossAsteroid.radius;
                if (bossAsteroid.x > canvas.width + bossAsteroid.radius) bossAsteroid.x = -bossAsteroid.radius;

                // Collision with ship
                if (!ship.invulnerable && !ship.shield) {
                    let dx = ship.x - bossAsteroid.x;
                    let dy = ship.y - bossAsteroid.y;
                    let dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < ship.radius + bossAsteroid.radius) {
                        lives--;
                        ship.invulnerable = true;
                        // Hardcore 2: Much less invulnerability time from boss
                        ship.invulnerableTime = gameMode === 'hardcore2' ? 60 : 120;
                        addScreenShake(20);
                        createParticles(ship.x, ship.y, '#ff4d4d', 50, 8, 6);
                        playSound(100, 0.4, 'sawtooth', 0.25);
                        
                        if (lives <= 0) {
                            gameOver();
                            return;
                        }
                        updateLivesDisplay();
                    }
                }

                // Bullet collision with boss
                ship.bullets.forEach((b, j) => {
                    let dx = b.x - bossAsteroid.x;
                    let dy = b.y - bossAsteroid.y;
                    let dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < bossAsteroid.radius) {
                        // Hardcore 2: Double damage to boss
                        bossAsteroid.health -= (gameMode === 'hardcore2' ? 2 : 1);
                        addScreenShake(10);
                        playSound(200, 0.15, 'square', 0.2);
                        createParticles(bossAsteroid.x, bossAsteroid.y, '#ff4d4d', 25, 6, 5);
                        ship.bullets.splice(j, 1);

                        if (bossAsteroid.health <= 0) {
                            score += 1000 * level;
                            asteroidsDestroyed++;
                            unlockAchievement('boss_killer');
                            addScreenShake(25);
                            playSound(100, 0.5, 'sawtooth', 0.3);
                            createParticles(bossAsteroid.x, bossAsteroid.y, '#ffc107', 60, 10, 6);
                            bossAsteroid = null;
                            bossSpawned = false;
                            updateScore();
                        }
                    }
                });
            }

            // Check for level complete (only if no asteroids and no boss, and no bullets in flight)
            // Survival mode doesn't have levels - it's continuous
            if (gameMode !== 'survival' && asteroids.length === 0 && !bossAsteroid && ship.bullets.length === 0) {
                // Small delay to ensure all asteroids are cleared
                if (!window.levelCompletePending) {
                    window.levelCompletePending = true;
                    
                    setTimeout(() => {
                        // Double check asteroids are still cleared
                        if (asteroids.length === 0 && !bossAsteroid) {
                            const bonus = 500 * level;
                            score += bonus;
                            updateScore();
                            
                            // Show level complete
                            document.getElementById('levelBonus').textContent = bonus.toLocaleString();
                            document.getElementById('levelComplete').style.display = 'flex';
                            playSound(600, 0.3, 'sine', 0.2);
                            
                            setTimeout(() => {
                                // Check for perfect level achievement
                                if (lives >= currentLevelStartLives) {
                                    unlockAchievement('perfect_level');
                                }
                                
                                document.getElementById('levelComplete').style.display = 'none';
                                level++;
                                updateLevel();
                                window.levelCompletePending = false;
                                
                                // Endless mode: no level cap
                                if (gameMode === 'endless') {
                                    initLevel();
                                } else if (level <= 20) { // Classic and hardcore have level 20 cap
                                    initLevel();
                                } else {
                                    // Game complete!
                                    gameOver();
                                }
                            }, 2000);
                        } else {
                            window.levelCompletePending = false;
                        }
                    }, 500);
                }
            }

            // Update particles
            particles = particles.filter(p => {
                p.x += p.dx;
                p.y += p.dy;
                p.life--;
                p.rotation += p.rotationSpeed;
                p.dx *= 0.98;
                p.dy *= 0.98;
                return p.life > 0;
            });

            draw();
            requestAnimationFrame(update);
        }

        function draw() {
            ctx.save();
            ctx.translate(screenShake.x, screenShake.y);
            
            // Clear with fade effect
            ctx.fillStyle = 'rgba(0, 0, 0, 0.15)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw stars with twinkle
            stars.forEach(star => {
                const brightness = 0.3 + Math.sin(star.twinkle) * 0.2 + star.brightness * 0.5;
                ctx.globalAlpha = brightness;
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.globalAlpha = 1;

            // Draw particles
            particles.forEach(p => {
                const alpha = p.life / p.maxLife;
                ctx.globalAlpha = alpha;
                
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.rotation);
                
                if (p.glow) {
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = p.color;
                }
                
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(0, 0, p.size, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.shadowBlur = 0;
                ctx.restore();
            });
            ctx.globalAlpha = 1;

            // Draw power-ups
            powerUps.forEach(pu => {
                ctx.save();
                ctx.translate(pu.x, pu.y);
                ctx.rotate(pu.rotation);
                
                const pulseSize = 15 + Math.sin(pu.pulse) * 3;
                const colors = {
                    'rapid-fire': '#ff4d4d',
                    'shield': '#4a9eff',
                    'multi-shot': '#ffc107',
                    'slow-mo': '#51cf66',
                    'explosive': '#ff6b6b'
                };
                
                ctx.strokeStyle = colors[pu.type] || '#fff';
                ctx.lineWidth = 3;
                ctx.shadowBlur = 10;
                ctx.shadowColor = colors[pu.type] || '#fff';
                ctx.beginPath();
                ctx.arc(0, 0, pulseSize, 0, Math.PI * 2);
                ctx.stroke();
                
                ctx.fillStyle = colors[pu.type] || '#fff';
                ctx.globalAlpha = 0.2;
                ctx.fill();
                ctx.globalAlpha = 1;
                ctx.shadowBlur = 0;
                
                ctx.restore();
            });

            // Draw ship trail
            ship.trail.forEach((t, i) => {
                const alpha = t.life / 10;
                ctx.globalAlpha = alpha * 0.5;
                ctx.fillStyle = '#4a9eff';
                ctx.beginPath();
                ctx.arc(t.x, t.y, 3, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.globalAlpha = 1;

            // Draw ship
            if (!ship.invulnerable || Math.floor(ship.invulnerableTime / 5) % 2 === 0) {
                ctx.save();
                ctx.translate(ship.x, ship.y);
                ctx.rotate(ship.angle);
                
                // Shield effect
                if (ship.shield) {
                    ctx.strokeStyle = '#4a9eff';
                    ctx.lineWidth = 3;
                    ctx.globalAlpha = 0.6;
                    ctx.shadowBlur = 20;
                    ctx.shadowColor = '#4a9eff';
                    ctx.beginPath();
                    ctx.arc(0, 0, ship.radius + 12, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.shadowBlur = 0;
                    ctx.globalAlpha = 1;
                }
                
                // Ship body with gradient
                const gradient = ctx.createLinearGradient(20, 0, -15, 0);
                gradient.addColorStop(0, '#8bc5ff');
                gradient.addColorStop(0.5, '#4a9eff');
                gradient.addColorStop(1, '#2563eb');
                
                ctx.strokeStyle = "#4a9eff";
                ctx.lineWidth = 2.5;
                ctx.shadowBlur = 5;
                ctx.shadowColor = '#4a9eff';
                ctx.beginPath();
                ctx.moveTo(20, 0);
                ctx.lineTo(-15, 12);
                ctx.lineTo(-10, 0);
                ctx.lineTo(-15, -12);
                ctx.closePath();
                ctx.stroke();
                
                ctx.fillStyle = gradient;
                ctx.fill();
                ctx.shadowBlur = 0;
                
                ctx.restore();
            }

            // Draw bullets with glow
            ship.bullets.forEach(b => {
                if (b.laser) {
                    // Laser beam effect
                    ctx.strokeStyle = '#00ffff';
                    ctx.lineWidth = 3;
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = '#00ffff';
                    ctx.beginPath();
                    ctx.moveTo(ship.x, ship.y);
                    ctx.lineTo(b.x, b.y);
                    ctx.stroke();
                    
                    ctx.fillStyle = '#00ffff';
                    ctx.shadowBlur = 10;
                } else if (b.homing) {
                    ctx.fillStyle = '#ff00ff';
                    ctx.shadowBlur = 12;
                    ctx.shadowColor = '#ff00ff';
                } else {
                    ctx.fillStyle = "#ff4d4d";
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = '#ff4d4d';
                }
                
                ctx.beginPath();
                ctx.arc(b.x, b.y, b.size || 3, 0, Math.PI*2);
                ctx.fill();
            });
            ctx.shadowBlur = 0;

            // Draw asteroids
            asteroids.forEach(a => {
                drawAsteroid(a);
            });

            // Draw boss asteroid
            if (bossAsteroid) {
                drawAsteroid(bossAsteroid, true);
                
                // Boss health bar
                const barWidth = 200;
                const barHeight = 10;
                const barX = bossAsteroid.x - barWidth / 2;
                const barY = bossAsteroid.y - bossAsteroid.radius - 30;
                
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.fillRect(barX, barY, barWidth, barHeight);
                
                const healthPercent = bossAsteroid.health / bossAsteroid.maxHealth;
                ctx.fillStyle = healthPercent > 0.5 ? '#51cf66' : healthPercent > 0.25 ? '#ffc107' : '#ff4d4d';
                ctx.fillRect(barX, barY, barWidth * healthPercent, barHeight);
                
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.strokeRect(barX, barY, barWidth, barHeight);
            }
            
            ctx.restore();
        }

        function drawAsteroid(a, isBoss = false) {
            ctx.save();
            ctx.translate(a.x, a.y);
            ctx.rotate(a.rotation);
            
            const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, a.radius);
            if (isBoss) {
                gradient.addColorStop(0, 'rgba(255, 77, 77, 0.6)');
                gradient.addColorStop(0.5, 'rgba(255, 77, 77, 0.3)');
                gradient.addColorStop(1, 'rgba(255, 77, 77, 0.1)');
                ctx.strokeStyle = "#ff4d4d";
                ctx.lineWidth = 4;
                ctx.shadowBlur = 20;
                ctx.shadowColor = '#ff4d4d';
                
                // Boss pulsing effect
                const pulse = Math.sin(Date.now() / 200) * 2;
                ctx.scale(1 + pulse * 0.05, 1 + pulse * 0.05);
            } else {
                gradient.addColorStop(0, 'rgba(255, 255, 255, 0.5)');
                gradient.addColorStop(0.7, 'rgba(255, 255, 255, 0.2)');
                gradient.addColorStop(1, 'rgba(255, 255, 255, 0.05)');
                ctx.strokeStyle = "#e0e0e0";
                ctx.lineWidth = 2;
                ctx.shadowBlur = 5;
                ctx.shadowColor = '#ffffff';
            }
            
            ctx.beginPath();
            ctx.moveTo(a.vertices[0].x, a.vertices[0].y);
            for (let i = 1; i < a.vertices.length; i++) {
                ctx.lineTo(a.vertices[i].x, a.vertices[i].y);
            }
            ctx.closePath();
            ctx.stroke();
            
            ctx.fillStyle = gradient;
            ctx.fill();
            ctx.shadowBlur = 0;
            
            ctx.restore();
        }

        function updateScore() {
            document.getElementById("score").innerText = `Score: ${score.toLocaleString()}`;
            document.getElementById("highScore").innerText = `High Score: ${highScore.toLocaleString()}`;
        }

        function updateLevel() {
            if (gameMode === 'survival') {
                // Don't update level display in survival mode - it's handled in update loop
                return;
            }
            document.getElementById("level").innerText = `Level ${level}`;
        }

        function updateLivesDisplay() {
            if (gameMode === 'hardcore2') {
                // Hardcore 2: Use ‚ù§Ô∏è‚Äçü©π instead of ‚ù§Ô∏è
                const hearts = '‚ù§Ô∏è‚Äçü©π'.repeat(lives);
                document.getElementById("lives").innerText = `Lives: ${hearts}`;
            } else {
                const hearts = '‚ù§Ô∏è'.repeat(lives);
                document.getElementById("lives").innerText = `Lives: ${hearts}`;
            }
        }

        function gameOver() {
            isGameOver = true;
            isPaused = true;
            
            // Calculate survival time for survival mode
            if (gameMode === 'survival') {
                survivalTime = Math.floor((Date.now() - gameStartTime) / 1000);
            }
            
            // Check achievements
            const newlyUnlocked = checkAchievements();
            
            // Save to leaderboard
            saveToLeaderboard({
                mode: gameMode,
                score: score,
                level: level,
                asteroidsDestroyed: asteroidsDestroyed,
                survivalTime: gameMode === 'survival' ? survivalTime : null,
                date: Date.now()
            });
            
            // Update high score
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('asteroidsHighScore', highScore.toString());
            }
            
            // Display game over screen
            document.getElementById("finalScore").textContent = score.toLocaleString();
            document.getElementById("finalHighScore").textContent = highScore.toLocaleString();
            document.getElementById("finalLevel").textContent = level;
            document.getElementById("finalAsteroids").textContent = asteroidsDestroyed.toLocaleString();
            
            // Show newly unlocked achievements
            if (newlyUnlocked.length > 0) {
                const newAchDiv = document.getElementById('newAchievements');
                const newAchList = document.getElementById('newAchievementsList');
                newAchList.innerHTML = '';
                newlyUnlocked.forEach(ach => {
                    const item = document.createElement('div');
                    item.className = 'new-achievement-item';
                    item.innerHTML = `${ach.icon} ${ach.name} - ${ach.desc}`;
                    newAchList.appendChild(item);
                });
                newAchDiv.style.display = 'block';
            } else {
                document.getElementById('newAchievements').style.display = 'none';
            }
            
            document.getElementById("gameOverScreen").style.display = 'flex';
            playSound(150, 0.5, 'sawtooth', 0.3);
        }
        
        function startGame(mode) {
            // If hardcore2Global is active, always force hardcore2 mode regardless of selected mode
            if (hardcore2Global) {
                gameMode = 'hardcore2';
                console.log('üî• HARDCORE 2 MODE FORCED - All games are in hardcore2 mode!');
            } else {
                gameMode = mode;
            }
            gameStartTime = Date.now();
            survivalTime = 0;
            lastSurvivalSpawn = 0;
            score = 0;
            level = 1;
            lives = (gameMode === 'hardcore' || gameMode === 'hardcore2') ? 1 : 3;
            asteroidsDestroyed = 0;
            powerUpsCollected = 0;
            comboCount = 0;
            killStreak = 0;
            activePowerUp = null;
            powerUpTime = 0;
            
            // Update mode display
            const modeNames = {
                'classic': 'Classic Mode',
                'hardcore': 'Hardcore Mode',
                'endless': 'Endless Mode',
                'survival': 'Survival Mode'
            };
            document.getElementById('gameModeDisplay').textContent = modeNames[mode];
            
            // Hide all screens, show game
            document.getElementById('modeSelectionScreen').style.display = 'none';
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('pauseScreen').style.display = 'none';
            document.getElementById('gameCanvas').style.display = 'block';
            document.querySelector('.game-ui').style.display = 'flex';
            document.querySelector('.game-instructions').style.display = 'block';
            
            // Initialize game
            initLevel();
            updateScore();
            if (gameMode === 'survival') {
                // Initialize survival time display
                document.getElementById("level").innerText = `Survival: 0:00`;
            } else {
                updateLevel();
            }
            updateLivesDisplay();
            isGameOver = false;
            isPaused = false;
            
            // Start game loop
            update();
        }
        
        function restartGame() {
            // Hide game over screen
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('pauseScreen').style.display = 'none';
            
            // Reset game state
            isGameOver = false;
            isPaused = false;
            
            // If hardcore2Global is active, always restart in hardcore2 mode
            const modeToUse = hardcore2Global ? 'hardcore2' : gameMode;
            startGame(modeToUse);
        }
        
        function showMainMenu() {
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('pauseScreen').style.display = 'none';
            document.getElementById('modeSelectionScreen').style.display = 'flex';
            document.getElementById('gameCanvas').style.display = 'none';
            document.querySelector('.game-ui').style.display = 'none';
            document.querySelector('.game-instructions').style.display = 'none';
            isPaused = false;
            isGameOver = false;
        }

        // Mode selection handlers
        document.querySelectorAll('.mode-button').forEach(btn => {
            btn.addEventListener('click', () => {
                const mode = btn.dataset.mode;
                startGame(mode);
            });
        });
        
        // Leaderboard handlers
        document.getElementById('leaderboardBtn').addEventListener('click', () => {
            displayLeaderboard('all');
            document.getElementById('leaderboardScreen').style.display = 'flex';
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === 'all') btn.classList.add('active');
            });
        });
        
        document.getElementById('closeLeaderboardBtn').addEventListener('click', () => {
            document.getElementById('leaderboardScreen').style.display = 'none';
        });
        
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                displayLeaderboard(btn.dataset.tab);
            });
        });
        
        // Achievements handlers
        document.getElementById('achievementsBtn').addEventListener('click', () => {
            displayAchievements();
            document.getElementById('achievementsScreen').style.display = 'flex';
        });
        
        document.getElementById('closeAchievementsBtn').addEventListener('click', () => {
            document.getElementById('achievementsScreen').style.display = 'none';
        });
        
        // Game over handlers
        document.getElementById('restartBtn').addEventListener('click', restartGame);
        document.getElementById('mainMenuBtn').addEventListener('click', showMainMenu);
        document.getElementById('mainMenuFromPauseBtn').addEventListener('click', showMainMenu);
        
        // Pause and sound handlers
        document.getElementById('pauseBtn').addEventListener('click', togglePause);
        document.getElementById('soundBtn').addEventListener('click', toggleSound);
        
        // Initialize achievements
        getAchievements();
        
        // Hide game initially, show mode selection
        document.getElementById('gameCanvas').style.display = 'none';
        document.querySelector('.game-ui').style.display = 'none';
        document.querySelector('.game-instructions').style.display = 'none';
        document.getElementById('modeSelectionScreen').style.display = 'flex';
        
        // Cursor Trail Effect
        const trails = [];
        const maxTrails = 50;
        let lastTime = 0;
        
        function createCursorTrail(x, y) {
            const trail = document.createElement('div');
            trail.className = 'cursor-trail';
            trail.style.left = x + 'px';
            trail.style.top = y + 'px';
            trail.style.opacity = '0.6';
            document.body.appendChild(trail);
            
            requestAnimationFrame(() => {
                trail.style.opacity = '0';
                trail.style.transform = 'translate(-50%, -50%) scale(0.2)';
            });
            
            setTimeout(() => {
                if (trail.parentNode) {
                    trail.remove();
                }
            }, 800);
            
            trails.push(trail);
            if (trails.length > maxTrails) {
                const oldTrail = trails.shift();
                if (oldTrail && oldTrail.parentNode) {
                    oldTrail.remove();
                }
            }
        }
        
        let lastX = 0;
        let lastY = 0;
        
        document.addEventListener('mousemove', (e) => {
            const now = Date.now();
            if (now - lastTime > 8) {
                const distance = Math.sqrt(
                    Math.pow(e.clientX - lastX, 2) + Math.pow(e.clientY - lastY, 2)
                );
                
                if (distance > 2) {
                    createCursorTrail(e.clientX, e.clientY);
                    lastX = e.clientX;
                    lastY = e.clientY;
                    lastTime = now;
                }
            }
        });
    </script>
    
    <!-- Hardcore 2 Dark Overlay -->
    <div id="hardcore2Overlay" class="hardcore2-overlay" style="display: none;"></div>
    
    <script>
        // Apply dark overlay if Hardcore 2 is active
        function updateHardcore2Overlay() {
            const overlay = document.getElementById('hardcore2Overlay');
            const isActive = localStorage.getItem('hardcore2Global') === 'true';
            if (overlay && isActive) {
                overlay.style.display = 'block';
            } else if (overlay) {
                overlay.style.display = 'none';
            }
        }
        
        // Check on page load
        updateHardcore2Overlay();
        // Check periodically in case it gets activated
        setInterval(updateHardcore2Overlay, 100);
    </script>
</body>
</html>
