<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanksgiving Event - JNJ Website</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="animated-background.css">
    <script src="animated-background.js" defer></script>
    <script src="page-transitions.js" defer></script>
    <script src="firebase-config.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="auth.js" defer></script>
    <style>
        .event-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .event-header {
            text-align: center;
            margin-bottom: 50px;
        }

        .event-header img {
            max-width: 100%;
            height: auto;
            margin-bottom: 20px;
        }

        .event-title {
            font-size: 48px;
            font-weight: bold;
            color: #f59e0b;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .event-subtitle {
            font-size: 20px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 40px;
        }

        .claimable-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .claimable-item {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(245, 158, 11, 0.3);
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .claimable-item:hover {
            transform: translateY(-5px);
            border-color: rgba(245, 158, 11, 0.6);
            box-shadow: 0 10px 30px rgba(245, 158, 11, 0.3);
        }

        .claimable-item.claimed {
            border-color: rgba(34, 197, 94, 0.6);
            background: rgba(34, 197, 94, 0.1);
        }

        .item-icon {
            font-size: 64px;
            margin-bottom: 20px;
            display: block;
        }

        .item-title {
            font-size: 24px;
            font-weight: bold;
            color: #f59e0b;
            margin-bottom: 10px;
        }

        .item-description {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 20px;
            min-height: 40px;
        }

        .claim-button {
            background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .claim-button:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(217, 119, 6, 0.6);
        }

        .claim-button:disabled {
            background: rgba(34, 197, 94, 0.3);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .claimed-badge {
            display: inline-block;
            background: rgba(34, 197, 94, 0.3);
            color: #22c55e;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-top: 10px;
        }

        .claimed-badge.equipped {
            background: rgba(34, 197, 94, 0.4);
            color: #22c55e;
        }

        .claimed-badge.not-equipped {
            background: rgba(245, 158, 11, 0.3);
            color: #f59e0b;
        }

        .back-button {
            display: inline-block;
            margin-top: 30px;
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-5px);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(34, 197, 94, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: bold;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Minigame Styles */
        .minigame-section {
            margin: 60px 0;
            padding: 30px;
            background: linear-gradient(135deg, rgba(139, 69, 19, 0.3) 0%, rgba(160, 82, 45, 0.2) 100%);
            border: 3px solid rgba(245, 158, 11, 0.4);
            border-radius: 20px;
            text-align: center;
        }

        .minigame-title {
            font-size: 32px;
            font-weight: bold;
            color: #f59e0b;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .minigame-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 400px;
            margin: 20px auto;
            background: linear-gradient(180deg, rgba(26, 26, 46, 0.8) 0%, rgba(15, 52, 96, 0.8) 100%);
            border: 3px solid rgba(245, 158, 11, 0.5);
            border-radius: 15px;
            overflow: hidden;
            cursor: none;
        }

        .game-basket {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 60px;
            transition: left 0.1s linear;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.5));
            z-index: 10;
            pointer-events: none;
        }

        .game-turkey {
            position: absolute;
            font-size: 40px;
            transition: top 0.05s linear;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
            z-index: 5;
            pointer-events: none;
        }

        .game-stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .stat-item {
            color: white;
            font-size: 18px;
            font-weight: bold;
        }

        .stat-value {
            color: #f59e0b;
            font-size: 24px;
        }

        .game-button {
            background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .game-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(217, 119, 6, 0.6);
        }

        .game-button:disabled {
            background: rgba(156, 163, 175, 0.5);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .game-instructions {
            color: rgba(255, 255, 255, 0.8);
            font-size: 16px;
            margin-bottom: 20px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">
        <div class="event-container">
            <div class="event-header">
                <img src="thanksgivingheader.png" alt="Thanksgiving Header">
                <h1 class="event-title">ü¶É Thanksgiving Event ü¶É</h1>
                <p class="event-subtitle">Claim your special Thanksgiving rewards!</p>
            </div>

            <div class="claimable-items">
                <!-- Title: Turkey King -->
                <div class="claimable-item" id="titleItem">
                    <span class="item-icon">üëë</span>
                    <h2 class="item-title">Turkey King</h2>
                    <p class="item-description">Unlock the exclusive "Turkey King" title for your profile!</p>
                    <button class="claim-button" onclick="claimTitle()" id="titleButton">Claim Title</button>
                    <div id="titleBadge" class="claimed-badge" style="display: none;">‚úì Claimed</div>
                </div>

                <!-- Profile Emoji: Turkey -->
                <div class="claimable-item" id="emojiItem">
                    <span class="item-icon">ü¶É</span>
                    <h2 class="item-title">Turkey Emoji</h2>
                    <p class="item-description">Set the turkey emoji as your profile avatar!</p>
                    <button class="claim-button" onclick="claimEmoji()" id="emojiButton">Claim Emoji</button>
                    <div id="emojiBadge" class="claimed-badge" style="display: none;">‚úì Claimed</div>
                </div>

                <!-- Background Particles: Leaves -->
                <div class="claimable-item" id="particlesItem">
                    <span class="item-icon">üçÇ</span>
                    <h2 class="item-title">Falling Leaves</h2>
                    <p class="item-description">Enable beautiful falling leaves as your background particles!</p>
                    <button class="claim-button" onclick="claimParticles()" id="particlesButton">Claim Particles</button>
                    <div id="particlesBadge" class="claimed-badge" style="display: none;">‚úì Claimed</div>
                </div>
            </div>

            <!-- Minigame Section -->
            <div class="minigame-section">
                <h2 class="minigame-title">üéÆ Catch the Turkey! ü¶É</h2>
                <p class="game-instructions">
                    Move your mouse to control the basket. Catch as many turkeys as you can!<br>
                    Avoid missing too many or the game ends!
                </p>
                
                <div class="game-stats">
                    <div class="stat-item">
                        Score: <span class="stat-value" id="gameScore">0</span>
                    </div>
                    <div class="stat-item">
                        Caught: <span class="stat-value" id="gameCaught">0</span>
                    </div>
                    <div class="stat-item">
                        Missed: <span class="stat-value" id="gameMissed">0</span>
                    </div>
                </div>

                <div class="minigame-container" id="gameContainer">
                    <div class="game-basket" id="gameBasket">üß∫</div>
                </div>

                <div style="margin-top: 20px;">
                    <button class="game-button" id="startGameBtn" onclick="startGame()">Start Game</button>
                    <button class="game-button" id="pauseGameBtn" onclick="pauseGame()" style="display: none;">Pause</button>
                </div>
            </div>

            <div style="text-align: center;">
                <a href="index.html" class="back-button">‚Üê Back to Home</a>
            </div>
        </div>
    </div>

    <script>
        const PROFILE_STORAGE_KEY = 'jnjUserProfile';

        // Check claim status on load
        function checkClaimStatus() {
            const profile = JSON.parse(localStorage.getItem(PROFILE_STORAGE_KEY) || '{}');
            const unlockedTitles = profile.unlockedTitles || [];
            const equippedTitle = profile.equippedTitle;
            const avatar = profile.avatar;
            const particleType = profile.particleType;
            const claimedEmojis = profile.claimedEmojis || [];

            // Check title
            if (unlockedTitles.includes('turkey-king') || equippedTitle === 'turkey-king') {
                markAsClaimed('titleItem', 'titleButton', 'titleBadge');
            }

            // Check emoji - check if claimed and if equipped
            const turkeyClaimed = claimedEmojis.includes('ü¶É');
            const turkeyEquipped = avatar === 'ü¶É';
            
            // If equipped but not in claimed list, add it to claimed list
            if (turkeyEquipped && !turkeyClaimed) {
                claimedEmojis.push('ü¶É');
                profile.claimedEmojis = claimedEmojis;
                localStorage.setItem(PROFILE_STORAGE_KEY, JSON.stringify(profile));
            }
            
            if (turkeyClaimed || turkeyEquipped) {
                if (turkeyEquipped) {
                    markAsEquipped('emojiItem', 'emojiButton', 'emojiBadge');
                } else {
                    markAsClaimedButNotEquipped('emojiItem', 'emojiButton', 'emojiBadge');
                }
            }

            // Check particles - check if leaves are claimed
            const claimedParticles = profile.claimedParticles || [];
            const leavesClaimed = claimedParticles.includes('leaves') || particleType === 'leaves';
            
            if (leavesClaimed) {
                markAsClaimed('particlesItem', 'particlesButton', 'particlesBadge');
            }
        }

        function markAsClaimed(itemId, buttonId, badgeId) {
            const item = document.getElementById(itemId);
            const button = document.getElementById(buttonId);
            const badge = document.getElementById(badgeId);
            
            if (item && button && badge) {
                item.classList.add('claimed');
                button.disabled = true;
                button.textContent = 'Claimed';
                badge.style.display = 'block';
            }
        }

        function markAsClaimedButNotEquipped(itemId, buttonId, badgeId) {
            const item = document.getElementById(itemId);
            const button = document.getElementById(buttonId);
            const badge = document.getElementById(badgeId);
            
            if (item && button && badge) {
                item.classList.add('claimed');
                button.disabled = false;
                button.textContent = 'Equip Turkey';
                button.onclick = () => equipEmoji();
                badge.textContent = '‚úì Claimed (Not Equipped)';
                badge.className = 'claimed-badge not-equipped';
                badge.style.display = 'block';
            }
        }

        function markAsEquipped(itemId, buttonId, badgeId) {
            const item = document.getElementById(itemId);
            const button = document.getElementById(buttonId);
            const badge = document.getElementById(badgeId);
            
            if (item && button && badge) {
                item.classList.add('claimed');
                button.disabled = false;
                button.textContent = 'Unequip Turkey';
                button.onclick = () => unequipEmoji();
                badge.textContent = '‚úì Equipped';
                badge.className = 'claimed-badge equipped';
                badge.style.display = 'block';
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        async function claimTitle() {
            try {
                console.log('claimTitle called');
                let profile = JSON.parse(localStorage.getItem(PROFILE_STORAGE_KEY) || '{}');
                const unlockedTitles = profile.unlockedTitles || [];
                
                if (!unlockedTitles.includes('turkey-king')) {
                    unlockedTitles.push('turkey-king');
                    profile.unlockedTitles = unlockedTitles;
                    profile.equippedTitle = 'turkey-king'; // Auto-equip
                    
                    // Save to localStorage
                    localStorage.setItem(PROFILE_STORAGE_KEY, JSON.stringify(profile));
                    
                    // Save to Firestore if authenticated
                    if (window.authSystem && window.authSystem.isAuthenticated()) {
                        await window.authSystem.saveUserData({ profile: profile });
                    }
                    
                    markAsClaimed('titleItem', 'titleButton', 'titleBadge');
                    showNotification('‚úì Turkey King title claimed and equipped!');
                } else {
                    showNotification('Title already claimed!');
                }
            } catch (e) {
                console.error('Error claiming title:', e);
                showNotification('Error claiming title. Please try again.');
            }
        }

        async function claimEmoji() {
            try {
                let profile = JSON.parse(localStorage.getItem(PROFILE_STORAGE_KEY) || '{}');
                const claimedEmojis = profile.claimedEmojis || [];
                
                if (!claimedEmojis.includes('ü¶É')) {
                    // First time claiming - unlock it and equip it
                    claimedEmojis.push('ü¶É');
                    profile.claimedEmojis = claimedEmojis;
                    profile.avatar = 'ü¶É';
                    profile.avatarImage = null; // Clear any image avatar
                    
                    // Save to localStorage
                    localStorage.setItem(PROFILE_STORAGE_KEY, JSON.stringify(profile));
                    
                    // Save to Firestore if authenticated
                    if (window.authSystem && window.authSystem.isAuthenticated()) {
                        await window.authSystem.saveUserData({ profile: profile });
                    }
                    
                    markAsEquipped('emojiItem', 'emojiButton', 'emojiBadge');
                    showNotification('‚úì Turkey emoji claimed and equipped!');
                }
            } catch (e) {
                console.error('Error claiming emoji:', e);
                showNotification('Error claiming emoji. Please try again.');
            }
        }

        async function equipEmoji() {
            try {
                let profile = JSON.parse(localStorage.getItem(PROFILE_STORAGE_KEY) || '{}');
                
                profile.avatar = 'ü¶É';
                profile.avatarImage = null; // Clear any image avatar
                
                // Save to localStorage
                localStorage.setItem(PROFILE_STORAGE_KEY, JSON.stringify(profile));
                
                // Save to Firestore if authenticated
                if (window.authSystem && window.authSystem.isAuthenticated()) {
                    await window.authSystem.saveUserData({ profile: profile });
                }
                
                markAsEquipped('emojiItem', 'emojiButton', 'emojiBadge');
                showNotification('‚úì Turkey emoji equipped!');
            } catch (e) {
                console.error('Error equipping emoji:', e);
                showNotification('Error equipping emoji. Please try again.');
            }
        }

        async function unequipEmoji() {
            try {
                let profile = JSON.parse(localStorage.getItem(PROFILE_STORAGE_KEY) || '{}');
                
                // Set to default emoji if no other avatar is set
                if (!profile.avatarImage) {
                    profile.avatar = 'üë§';
                } else {
                    // Keep the image avatar, just clear the emoji
                    profile.avatar = null;
                }
                
                // Save to localStorage
                localStorage.setItem(PROFILE_STORAGE_KEY, JSON.stringify(profile));
                
                // Save to Firestore if authenticated
                if (window.authSystem && window.authSystem.isAuthenticated()) {
                    await window.authSystem.saveUserData({ profile: profile });
                }
                
                markAsClaimedButNotEquipped('emojiItem', 'emojiButton', 'emojiBadge');
                showNotification('‚úì Turkey emoji unequipped.');
            } catch (e) {
                console.error('Error unequipping emoji:', e);
                showNotification('Error unequipping emoji. Please try again.');
            }
        }

        async function claimParticles() {
            try {
                let profile = JSON.parse(localStorage.getItem(PROFILE_STORAGE_KEY) || '{}');
                const claimedParticles = profile.claimedParticles || [];
                
                if (!claimedParticles.includes('leaves')) {
                    // Claim falling leaves
                    claimedParticles.push('leaves');
                    profile.claimedParticles = claimedParticles;
                    profile.particleType = 'leaves'; // Set to leaves mode
                    
                    // Save to localStorage
                    localStorage.setItem(PROFILE_STORAGE_KEY, JSON.stringify(profile));
                    localStorage.setItem('particleType', 'leaves');
                    
                    // Save to Firestore if authenticated
                    if (window.authSystem && window.authSystem.isAuthenticated()) {
                        await window.authSystem.saveUserData({ profile: profile });
                    }
                    
                    markAsClaimed('particlesItem', 'particlesButton', 'particlesBadge');
                    showNotification('‚úì Falling leaves claimed! They will appear as a selectable option in your profile.');
                }
            } catch (e) {
                console.error('Error claiming particles:', e);
                showNotification('Error claiming particles. Please try again.');
            }
        }

        // Minigame Variables
        let gameRunning = false;
        let gamePaused = false;
        let gameScore = 0;
        let gameCaught = 0;
        let gameMissed = 0;
        let turkeys = [];
        let gameAnimationId = null;
        let turkeySpawnInterval = null;
        let mouseMoveHandler = null;
        const MAX_MISSED = 5;

        function startGame() {
            console.log('startGame called', { gameRunning, gamePaused });
            if (gameRunning && !gamePaused) return;
            
            if (gamePaused) {
                gamePaused = false;
                gameLoop();
                document.getElementById('pauseGameBtn').textContent = 'Pause';
                return;
            }

            // Reset game
            gameRunning = true;
            gamePaused = false;
            gameScore = 0;
            gameCaught = 0;
            gameMissed = 0;
            turkeys = [];
            
            // Clear container
            const container = document.getElementById('gameContainer');
            if (!container) {
                console.error('Game container not found');
                return;
            }
            const basket = document.getElementById('gameBasket');
            if (!basket) {
                console.error('Game basket not found');
                return;
            }
            container.innerHTML = '';
            container.appendChild(basket);
            
            // Update UI
            updateGameStats();
            const startBtn = document.getElementById('startGameBtn');
            const pauseBtn = document.getElementById('pauseGameBtn');
            if (startBtn) startBtn.style.display = 'none';
            if (pauseBtn) pauseBtn.style.display = 'inline-block';
            
            // Add mouse movement handler
            if (mouseMoveHandler) {
                container.removeEventListener('mousemove', mouseMoveHandler);
            }
            mouseMoveHandler = (e) => {
                const containerRect = container.getBoundingClientRect();
                const mouseX = e.clientX - containerRect.left;
                const basket = document.getElementById('gameBasket');
                if (basket) {
                    basket.style.left = Math.max(0, Math.min(container.offsetWidth - 60, mouseX - 30)) + 'px';
                }
            };
            container.addEventListener('mousemove', mouseMoveHandler);
            
            // Start spawning turkeys immediately and then periodically
            spawnTurkey(); // Spawn first turkey immediately
            if (turkeySpawnInterval) clearInterval(turkeySpawnInterval);
            turkeySpawnInterval = setInterval(() => {
                if (!gamePaused && gameRunning) {
                    spawnTurkey();
                }
            }, 1500);
            
            // Start game loop
            gameLoop();
        }

        function pauseGame() {
            if (!gameRunning) return;
            
            gamePaused = !gamePaused;
            
            if (gamePaused) {
                if (gameAnimationId) {
                    cancelAnimationFrame(gameAnimationId);
                }
                document.getElementById('pauseGameBtn').textContent = 'Resume';
            } else {
                gameLoop();
                document.getElementById('pauseGameBtn').textContent = 'Pause';
            }
        }

        function spawnTurkey() {
            if (!gameRunning || gamePaused) return;
            
            const container = document.getElementById('gameContainer');
            if (!container) return;
            
            const turkey = document.createElement('div');
            turkey.className = 'game-turkey';
            turkey.textContent = 'ü¶É';
            const leftPos = Math.random() * (container.offsetWidth - 50);
            turkey.style.left = leftPos + 'px';
            turkey.style.top = '-50px';
            turkey.style.position = 'absolute';
            container.appendChild(turkey);
            
            turkeys.push({
                element: turkey,
                x: leftPos,
                y: -50,
                speed: 2 + Math.random() * 2
            });
        }

        function gameLoop() {
            if (!gameRunning || gamePaused) {
                if (gameAnimationId) {
                    cancelAnimationFrame(gameAnimationId);
                    gameAnimationId = null;
                }
                return;
            }
            
            const container = document.getElementById('gameContainer');
            const basket = document.getElementById('gameBasket');
            if (!container || !basket) {
                endGame();
                return;
            }
            
            const basketRect = basket.getBoundingClientRect();
            
            // Update turkeys
            for (let i = turkeys.length - 1; i >= 0; i--) {
                const turkey = turkeys[i];
                if (!turkey.element.parentNode) {
                    turkeys.splice(i, 1);
                    continue;
                }
                
                turkey.y += turkey.speed;
                turkey.element.style.top = turkey.y + 'px';
                
                // Check collision with basket
                const turkeyRect = turkey.element.getBoundingClientRect();
                if (turkeyRect.bottom >= basketRect.top && 
                    turkeyRect.top <= basketRect.bottom &&
                    turkeyRect.left < basketRect.right &&
                    turkeyRect.right > basketRect.left) {
                    // Caught!
                    gameCaught++;
                    gameScore += 10;
                    turkey.element.remove();
                    turkeys.splice(i, 1);
                    updateGameStats();
                    continue;
                }
                
                // Check if missed (fell off screen)
                if (turkey.y > container.offsetHeight) {
                    gameMissed++;
                    turkey.element.remove();
                    turkeys.splice(i, 1);
                    updateGameStats();
                    
                    // Check game over
                    if (gameMissed >= MAX_MISSED) {
                        endGame();
                        return;
                    }
                }
            }
            
            // Continue the loop
            if (gameRunning && !gamePaused) {
                gameAnimationId = requestAnimationFrame(gameLoop);
            }
        }

        function updateGameStats() {
            document.getElementById('gameScore').textContent = gameScore;
            document.getElementById('gameCaught').textContent = gameCaught;
            document.getElementById('gameMissed').textContent = gameMissed;
        }

        function endGame() {
            gameRunning = false;
            gamePaused = false;
            
            if (gameAnimationId) {
                cancelAnimationFrame(gameAnimationId);
            }
            if (turkeySpawnInterval) {
                clearInterval(turkeySpawnInterval);
            }
            
            // Remove mouse handler
            const container = document.getElementById('gameContainer');
            if (mouseMoveHandler) {
                container.removeEventListener('mousemove', mouseMoveHandler);
                mouseMoveHandler = null;
            }
            
            // Clear all turkeys
            turkeys.forEach(turkey => turkey.element.remove());
            turkeys = [];
            
            // Update UI
            document.getElementById('startGameBtn').style.display = 'inline-block';
            document.getElementById('pauseGameBtn').style.display = 'none';
            
            // Show game over message
            showNotification(`üéÆ Game Over! Final Score: ${gameScore} (Caught: ${gameCaught})`);
        }

        // Make functions globally accessible
        window.claimTitle = claimTitle;
        window.claimEmoji = claimEmoji;
        window.claimParticles = claimParticles;
        window.equipEmoji = equipEmoji;
        window.unequipEmoji = unequipEmoji;
        window.startGame = startGame;
        window.pauseGame = pauseGame;

        // Mark this event as visited (only if user is authenticated)
        function markEventAsVisited() {
            try {
                // Only mark as visited if user is authenticated
                if (!window.authSystem || !window.authSystem.isAuthenticated()) {
                    return;
                }
                
                let profile = JSON.parse(localStorage.getItem(PROFILE_STORAGE_KEY) || '{}');
                const visitedEvents = profile.visitedEvents || [];
                
                // Add thanksgiving event if not already in list
                if (!visitedEvents.includes('thanksgiving')) {
                    visitedEvents.push('thanksgiving');
                    profile.visitedEvents = visitedEvents;
                    
                    // Save to localStorage
                    localStorage.setItem(PROFILE_STORAGE_KEY, JSON.stringify(profile));
                    
                    // Save to Firestore
                    if (window.authSystem && window.authSystem.isAuthenticated()) {
                        window.authSystem.saveUserData({ profile: profile }).catch(e => {
                            console.error('Error saving event visit:', e);
                        });
                    }
                }
            } catch (e) {
                console.error('Error marking event as visited:', e);
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkClaimStatus();
            markEventAsVisited();
        });

        // Also check when auth system is ready
        window.addEventListener('authStateChanged', () => {
            setTimeout(() => {
                checkClaimStatus();
                markEventAsVisited();
            }, 500);
        });
    </script>
</body>
</html>

